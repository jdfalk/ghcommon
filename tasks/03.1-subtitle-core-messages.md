# Task 3.1: Subtitle Core Message Types

<!-- file: tasks/03.1-subtitle-core-messages.md -->
<!-- version: 1.0.0 -->
<!-- guid: 45678901-4567-4567-4567-456789012abc -->

## Overview

Create fundamental protobuf message types for subtitle processing following the 1-1-1 design pattern and Edition 2023 standards. These core types will be the foundation for all subtitle operations.

## Critical Instructions

**NEVER edit README.md, CHANGELOG.md, TODO.md or other documentation files directly. ALWAYS use:**

- `scripts/create-doc-update.sh` for documentation updates
- `scripts/create-issue-update.sh` for issue updates

**ALWAYS follow the VS Code task priority:**

1. Use VS Code tasks first (via `run_task` tool)
2. Use `copilot-agent-util` / `copilot-agent-utilr`
3. Manual terminal commands only as last resort

Download copilot-agent-util from: <https://github.com/jdfalk/copilot-agent-util-rust>

## Required Standards

Follow all instructions from:

- [General coding instructions](../.github/instructions/general-coding.instructions.md)
- [Go instructions](../.github/instructions/go.instructions.md)
- [Protobuf instructions](../.github/instructions/protobuf.instructions.md)
- [Rust utility instructions](../.github/instructions/rust-utility.instructions.md)

## Core Message Types to Create

### 1. SubtitleRecord Message

**File:** `pkg/subtitle/proto/messages/subtitle_record.proto`

```protobuf
// file: pkg/subtitle/proto/messages/subtitle_record.proto
// version: 1.0.0
// guid: 11111111-1111-1111-1111-111111111111

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

import "pkg/subtitle/proto/messages/timing_info.proto";
import "pkg/subtitle/proto/messages/subtitle_content.proto";

// SubtitleRecord represents a single subtitle entry with timing and content
message SubtitleRecord {
  // Sequence number of this subtitle entry (1-based)
  int32 sequence = 1;
  
  // Timing information for when this subtitle should be displayed
  SubtitleTimingInfo timing = 2;
  
  // The actual content of the subtitle
  SubtitleContent content = 3;
  
  // Additional metadata for this subtitle entry
  map<string, string> metadata = 4;
  
  // Original raw text before any processing
  string original_text = 5;
  
  // Processing flags and status
  repeated string processing_flags = 6;
}
```

### 2. SubtitleFile Message

**File:** `pkg/subtitle/proto/messages/subtitle_file.proto`

```protobuf
// file: pkg/subtitle/proto/messages/subtitle_file.proto
// version: 1.0.0
// guid: 22222222-2222-2222-2222-222222222222

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

import "pkg/subtitle/proto/messages/subtitle_record.proto";
import "pkg/subtitle/proto/messages/subtitle_metadata.proto";
import "pkg/subtitle/proto/enums/subtitle_format.proto";

// SubtitleFile represents a complete subtitle file with all entries and metadata
message SubtitleFile {
  // Metadata about the subtitle file
  SubtitleMetadata metadata = 1;
  
  // All subtitle records in chronological order
  repeated SubtitleRecord records = 2;
  
  // Format of the subtitle file
  SubtitleFormat format = 3;
  
  // Raw content of the original file (for backup/reference)
  bytes raw_content = 4;
  
  // File encoding (UTF-8, UTF-16, etc.)
  string encoding = 5;
  
  // Checksum of the original file
  string checksum = 6;
  
  // Processing history
  repeated string processing_history = 7;
}
```

### 3. SubtitleMetadata Message

**File:** `pkg/subtitle/proto/messages/subtitle_metadata.proto`

```protobuf
// file: pkg/subtitle/proto/messages/subtitle_metadata.proto
// version: 1.0.0
// guid: 33333333-3333-3333-3333-333333333333

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

import "google/protobuf/timestamp.proto";

// SubtitleMetadata contains metadata information about a subtitle file
message SubtitleMetadata {
  // Original filename
  string filename = 1;
  
  // File size in bytes
  int64 file_size = 2;
  
  // When the file was created
  google.protobuf.Timestamp created_at = 3;
  
  // When the file was last modified
  google.protobuf.Timestamp modified_at = 4;
  
  // Language code (ISO 639-1/639-2)
  string language_code = 5;
  
  // Title or description of the subtitle content
  string title = 6;
  
  // Total number of subtitle entries
  int32 entry_count = 7;
  
  // Total duration of the subtitle file in milliseconds
  int64 duration_ms = 8;
  
  // Source or origin of the subtitle file
  string source = 9;
  
  // Author or creator
  string author = 10;
  
  // Additional custom metadata
  map<string, string> custom_metadata = 11;
}
```

### 4. TimingInfo Message

**File:** `pkg/subtitle/proto/messages/timing_info.proto`

```protobuf
// file: pkg/subtitle/proto/messages/timing_info.proto
// version: 1.0.0
// guid: 44444444-4444-4444-4444-444444444444

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

// SubtitleTimingInfo represents timing information for subtitle display
message SubtitleTimingInfo {
  // Start time in milliseconds from beginning of media
  int64 start_time_ms = 1;
  
  // End time in milliseconds from beginning of media
  int64 end_time_ms = 2;
  
  // Duration in milliseconds (end_time_ms - start_time_ms)
  int64 duration_ms = 3;
  
  // Timing validation flags
  repeated string timing_flags = 4;
  
  // Original timing string from source file (for reference)
  string original_timing = 5;
  
  // Timing adjustment offset in milliseconds
  int64 timing_offset_ms = 6;
}
```

### 5. SubtitleContent Message

**File:** `pkg/subtitle/proto/messages/subtitle_content.proto`

```protobuf
// file: pkg/subtitle/proto/messages/subtitle_content.proto
// version: 1.0.0
// guid: 55555555-5555-5555-5555-555555555555

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

import "pkg/subtitle/proto/messages/subtitle_styling.proto";

// SubtitleContent represents the text content and styling of a subtitle
message SubtitleContent {
  // Main text content of the subtitle
  string text = 1;
  
  // Styling information (colors, fonts, etc.)
  SubtitleStyling styling = 2;
  
  // Text split into separate lines
  repeated string lines = 3;
  
  // Plain text without any formatting
  string plain_text = 4;
  
  // HTML-formatted text (if applicable)
  string html_text = 5;
  
  // Language-specific processing flags
  repeated string language_flags = 6;
  
  // Text length in characters
  int32 character_count = 7;
  
  // Word count
  int32 word_count = 8;
}
```

### 6. SubtitleStyling Message

**File:** `pkg/subtitle/proto/messages/subtitle_styling.proto`

```protobuf
// file: pkg/subtitle/proto/messages/subtitle_styling.proto
// version: 1.0.0
// guid: 66666666-6666-6666-6666-666666666666

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.messages;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/messages;messagespb";

// SubtitleStyling represents styling information for subtitle text
message SubtitleStyling {
  // Text color in hex format (#RRGGBB)
  string text_color = 1;
  
  // Background color in hex format (#RRGGBB)
  string background_color = 2;
  
  // Font family name
  string font_family = 3;
  
  // Font size (relative or absolute)
  string font_size = 4;
  
  // Bold text flag
  bool bold = 5;
  
  // Italic text flag
  bool italic = 6;
  
  // Underline text flag
  bool underline = 7;
  
  // Text alignment (left, center, right)
  string alignment = 8;
  
  // Position on screen (if specified)
  SubtitlePosition position = 9;
  
  // Additional style properties
  map<string, string> custom_styles = 10;
}

// SubtitlePosition represents positioning information
message SubtitlePosition {
  // X coordinate (percentage or pixels)
  string x = 1;
  
  // Y coordinate (percentage or pixels)
  string y = 2;
  
  // Width (percentage or pixels)
  string width = 3;
  
  // Height (percentage or pixels)
  string height = 4;
}
```

## Enum Types to Create

### SubtitleFormat Enum

**File:** `pkg/subtitle/proto/enums/subtitle_format.proto`

```protobuf
// file: pkg/subtitle/proto/enums/subtitle_format.proto
// version: 1.0.0
// guid: 77777777-7777-7777-7777-777777777777

edition = "2023";

package github.com.jdfalk.gcommon.subtitle.enums;

option go_package = "github.com/jdfalk/gcommon/pkg/subtitle/proto/enums;enumspb";

// SubtitleFormat represents the format of subtitle files
enum SubtitleFormat {
  // Unknown or unspecified format
  SUBTITLE_FORMAT_UNSPECIFIED = 0;
  
  // SubRip format (.srt)
  SUBTITLE_FORMAT_SRT = 1;
  
  // WebVTT format (.vtt)
  SUBTITLE_FORMAT_VTT = 2;
  
  // Advanced SubStation Alpha (.ass)
  SUBTITLE_FORMAT_ASS = 3;
  
  // SubStation Alpha (.ssa)
  SUBTITLE_FORMAT_SSA = 4;
  
  // TTML (Timed Text Markup Language)
  SUBTITLE_FORMAT_TTML = 5;
  
  // SBV (YouTube subtitle format)
  SUBTITLE_FORMAT_SBV = 6;
  
  // LRC (LyRiCs format)
  SUBTITLE_FORMAT_LRC = 7;
  
  // JSON-based format
  SUBTITLE_FORMAT_JSON = 8;
  
  // XML-based format
  SUBTITLE_FORMAT_XML = 9;
}
```

## Tasks to Complete

### 1. Create Directory Structure

```bash
mkdir -p pkg/subtitle/proto/messages
mkdir -p pkg/subtitle/proto/enums
mkdir -p pkg/subtitle/proto/services
mkdir -p pkg/subtitle/proto/requests
mkdir -p pkg/subtitle/proto/responses
```

### 2. Create All Proto Files

Create each proto file with:

- Proper file headers (path, version, GUID)
- Edition 2023 declaration
- Correct package naming
- Proper go_package options
- Module prefix "Subtitle" for consistency
- Comprehensive field documentation

### 3. Update buf.yaml Configuration

Ensure the buf configuration includes the new proto directories:

```yaml
# Add to buf.yaml if not present
modules:
  - path: pkg/subtitle/proto
```

### 4. Generate Go Code

Run proto generation:

```bash
# Use VS Code task
run_task("Buf Generate with Output", "/path/to/subtitle-manager")

# Or use copilot-agent-util
copilot-agent-util buf generate
```

### 5. Verify Generated Code

Check that:

- All proto files generate Go code successfully
- Generated packages are in correct locations
- Import paths work correctly
- No compilation errors

### 6. Create Basic Tests

Create test files for each message type:

```go
// Example: pkg/subtitle/proto/messages/subtitle_record_test.go
func TestSubtitleRecordSerialization(t *testing.T) {
    // Test protobuf serialization/deserialization
}
```

## Acceptance Criteria

- [ ] All proto files created with proper headers and Edition 2023
- [ ] Consistent "Subtitle" module prefix used throughout
- [ ] Proper package naming and go_package options
- [ ] All proto files follow 1-1-1 design pattern
- [ ] Comprehensive field documentation
- [ ] `buf generate` runs without errors
- [ ] Generated Go code compiles successfully
- [ ] Basic serialization tests pass
- [ ] No import path conflicts
- [ ] Files follow protobuf best practices

## Next Steps

After completing this task:

1. Move to Task 3.2: Subtitle Processing Service
2. Create service definitions that use these message types
3. Implement request/response types for gRPC services
4. Begin Go service implementation

## Repository Location

Work in: `/Users/jdfalk/repos/github.com/jdfalk/subtitle-manager`

## Notes

- These message types are the foundation for all subtitle operations
- Focus on type safety and comprehensive field coverage
- Consider future extensibility when designing messages
- Test with real subtitle data to validate the design
- Ensure compatibility with common subtitle formats
