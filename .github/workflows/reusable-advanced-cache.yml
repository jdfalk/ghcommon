# file: .github/workflows/reusable-advanced-cache.yml
# version: 1.0.0
# guid: e5f6a7b8-c9d0-1e2f-3a4b-5c6d7e8f9a0b

name: Reusable Advanced Caching

on:
  workflow_call:
    inputs:
      language:
        description: Programming language ecosystem.
        required: true
        type: string
      cache-prefix:
        description: Base cache key prefix.
        required: true
        type: string
      include-branch:
        description: Include branch name in cache key.
        required: false
        default: false
        type: boolean
    outputs:
      cache-hit:
        description: Whether the cache was restored.
        value: ${{ jobs.cache.outputs.cache-hit }}
      cache-key:
        description: Generated cache key.
        value: ${{ jobs.cache.outputs.cache-key }}

permissions:
  contents: read

jobs:
  cache:
    name: Prepare Intelligent Cache
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
      cache-key: ${{ steps.generate-key.outputs.cache-key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect ghcommon ref
        id: ghcommon-ref
        run: |
          if [ -f .github/ghcommon-ref.txt ]; then
            echo "ref=$(cat .github/ghcommon-ref.txt)" >> $GITHUB_OUTPUT
          else
            echo "ref=main" >> $GITHUB_OUTPUT
          fi

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@v6
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          sparse-checkout: |
            .github/workflows/scripts
          path: .ghcommon

      - name: Set up GHCOMMON_SCRIPTS_DIR
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$GITHUB_WORKSPACE/.ghcommon/.github/workflows/scripts" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Determine cache metadata
        id: metadata
        run: |
          python "$GHCOMMON_SCRIPTS_DIR/automation_workflow.py" cache-plan \
            --language "${{ inputs.language }}" \
            --github-output

      - name: Generate intelligent cache key
        id: generate-key
        run: |
          set -eo pipefail
          INCLUDE_FLAG=""
          if [ "${{ inputs.include-branch }}" = "true" ]; then
            INCLUDE_FLAG="--include-branch"
          fi
          python "$GHCOMMON_SCRIPTS_DIR/automation_workflow.py" cache-key \
            --prefix "${{ inputs.cache-prefix }}" \
            --namespace "${{ inputs.language }}" \
            --files "${{ steps.metadata.outputs.files }}" \
            --paths "${{ steps.metadata.outputs.paths }}" \
            ${INCLUDE_FLAG}

      - name: Configure cache
        id: cache
        uses: actions/cache@v5
        with:
          key: ${{ steps.generate-key.outputs.cache-key }}
          restore-keys: |
            ${{ steps.generate-key.outputs.restore-keys }}
          path: |
            ${{ steps.generate-key.outputs.cache-paths }}

      - name: Report cache status
        run: |
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Cache hit for ${{ steps.generate-key.outputs.cache-key }}"
          else
            echo "⚠️  Cache miss for ${{ steps.generate-key.outputs.cache-key }}"
          fi
