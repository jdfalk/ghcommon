# file: .github/workflows/manager-sync-dispatcher.yml
# version: 2.1.1
# guid: a1b2c3d4-e5f6-7890-1234-567890abcdef

# DO NOT EDIT: This file is managed centrally in ghcommon repository
# To update: Edit the version in jdfalk/ghcommon and it will be synced to all repos

name: Manager Sync Dispatcher

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/**"
      - ".github/instructions/**"
      - ".github/copilot-instructions.md"
      - "labels.json"
      - "labels.md"
  workflow_dispatch:
    inputs:
      target_repos:
        description: "Comma-separated list of repos to sync (or 'all')"
        required: false
        default: "all"
        type: string
      sync_type:
        description: "Type of sync to perform"
        required: false
        default: "all"
        type: choice
        options:
          - "all"
          - "workflows"
          - "instructions"
          - "prompts"
          - "scripts"
          - "linters"
          - "labels"

permissions:
  contents: write
  actions: write
  packages: write
  pull-requests: write
  issues: write
  repository-projects: write
  checks: write
  statuses: write
  deployments: write

env:
  # Target repositories for synchronization
  # DO NOT ADD ghcommon as that would overwrite itself.
  TARGET_REPOS: |
    jdfalk/gcommon
    jdfalk/subtitle-manager
    jdfalk/copilot-agent-util-rust
    jdfalk/apt-cacher-go
    jdfalk/audiobook-organizer

jobs:
  dispatch-sync:
    name: Dispatch Sync Events
    runs-on: ubuntu-latest
    env:
      TARGET_REPOS_INPUT: ${{ github.event.inputs.target_repos }}
      SYNC_TYPE_INPUT: ${{ github.event.inputs.sync_type }}
      GITHUB_REPOSITORY_VAR: ${{ env.GITHUB_REPOSITORY }}
      GITHUB_SHA_VAR: ${{ env.GITHUB_SHA }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup GitHub CLI
        run: |
          # GitHub CLI is pre-installed on GitHub runners
          gh --version

      - name: Determine target repositories
        id: repos
        env:
          TARGET_REPOS_INPUT: ${{ github.event.inputs.target_repos }}
          TARGET_REPOS_LIST: ${{ env.TARGET_REPOS }}
        run: python3 ./.github/scripts/sync-determine-target-repos.py

      - name: Dispatch sync events to target repositories
        env:
          GH_TOKEN: ${{ secrets.JF_CI_GH_PAT || secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_TYPE: sync-from-ghcommon
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF: ${{ github.ref }}
        run: python3 ./.github/scripts/sync-dispatch-events.py

      - name: Summary
        env:
          TARGET_REPOS: ${{ steps.repos.outputs.target_repos }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: python3 ./.github/scripts/sync-generate-summary.py
