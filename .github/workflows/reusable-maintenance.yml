# file: .github/workflows/reusable-maintenance.yml
# version: 1.0.1
# guid: reusable-maintenance-2025-09-24-core-workflow

name: Reusable Maintenance Workflow

on:
  workflow_call:
    inputs:
      skip-dependency-updates:
        description: 'Skip dependency updates'
        required: false
        type: boolean
        default: false
      skip-cleanup:
        description: 'Skip cleanup tasks'
        required: false
        type: boolean
        default: false
      skip-license-check:
        description: 'Skip license compliance check'
        required: false
        type: boolean
        default: false
      auto-commit:
        description: 'Automatically commit maintenance changes'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  # Dependency Updates
  dependency-updates:
    name: Check Dependency Updates
    if: ${{ !inputs.skip-dependency-updates }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Detect ghcommon ref
        id: ghcommon-ref
        run: |
          if [ -f .github/ghcommon-ref.txt ]; then
            echo "ref=$(cat .github/ghcommon-ref.txt)" >> $GITHUB_OUTPUT
          else
            echo "ref=main" >> $GITHUB_OUTPUT
          fi

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@v6
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          sparse-checkout: |
            .github/workflows/scripts
          path: .ghcommon

      - name: Set up GHCOMMON_SCRIPTS_DIR
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$GITHUB_WORKSPACE/.ghcommon/.github/workflows/scripts" >> $GITHUB_ENV

      - name: Collect Go dependency updates
        if: hashFiles('go.mod') != ''
        run: |
          mkdir -p maintenance
          go list -u -m -json all > maintenance/go-outdated.json || true

      - name: Collect Node.js dependency updates
        if: hashFiles('package*.json') != ''
        run: |
          mkdir -p maintenance
          npm outdated --json > maintenance/npm-outdated.json 2>/dev/null || true

      - name: Collect Python dependency updates
        if: hashFiles('requirements*.txt', 'pyproject.toml') != ''
        run: |
          mkdir -p maintenance
          python -m pip install --upgrade pip
          python -m pip install pip-check-updates || true
          pip list --outdated --format=json > maintenance/pip-outdated.json 2>/dev/null || true

      - name: Collect Rust dependency updates
        if: hashFiles('Cargo.toml') != ''
        run: |
          mkdir -p maintenance
          cargo install cargo-outdated || true
          if command -v cargo-outdated >/dev/null 2>&1; then
            cargo outdated --format json > maintenance/cargo-outdated.json 2>/dev/null || true
          fi

      - name: Summarize dependency updates
        run: |
          python3 "$GHCOMMON_SCRIPTS_DIR/maintenance_workflow.py" summarize-dependencies \
            --pip maintenance/pip-outdated.json \
            --npm maintenance/npm-outdated.json \
            --cargo maintenance/cargo-outdated.json \
            --go maintenance/go-outdated.json \
            --output maintenance/dependency-summary.md

      - name: Upload dependency graph
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: maintenance-dependency-report
          path: maintenance

      - name: Summarize security advisories
        run: python3 "$GHCOMMON_SCRIPTS_DIR/maintenance_workflow.py" summarize-security --input maintenance/security-alerts.json || true

  # Repository Cleanup
  cleanup-tasks:
    name: Repository Cleanup
    if: ${{ !inputs.skip-cleanup }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Clean up temporary files
        run: |
          {
            echo "## Cleanup Tasks"
            echo ""

            CLEANED=0
            for pattern in "*.tmp" "*.temp" "*.log" "*.cache" ".DS_Store" "Thumbs.db"; do
              if find . -name "$pattern" -type f -not -path "./.git/*" | head -1 | grep -q .; then
                echo "Removing $pattern files:"
                find . -name "$pattern" -type f -not -path "./.git/*" -delete
                CLEANED=1
              fi
            done

            echo ""
            echo "### Large Files Check"
            find . -type f -size +10M -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./venv/*" -not -path "./target/*" |
              while IFS= read -r file; do
                echo "Large file detected: $file ($(du -h "$file" | cut -f1))"
              done

            if [ "$CLEANED" -eq 0 ]; then
              echo "No cleanup needed - repository is clean"
            fi
          } > cleanup-report.md

      - name: Check for unused dependencies
        run: |
          {
            echo ""
            echo "### Unused Dependencies Check"

            if [ -f go.mod ]; then
              go mod tidy
              if git diff --quiet go.mod go.sum; then
                echo "Go dependencies are clean"
              else
                echo "Go mod tidy made changes - consider reviewing dependencies"
              fi
            fi

            if command -v python3 >/dev/null && find . -name "*.py" -not -path "./venv/*" | head -1 | grep -q .; then
              echo "Python files present - consider running tools like unimport or autoflake"
            fi
          } >> cleanup-report.md

      - name: Upload cleanup report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: maintenance-cleanup-report
          path: cleanup-report.md

  # License Compliance Check
  license-check:
    name: License Compliance
    if: ${{ !inputs.skip-license-check }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check license files
        run: |
          echo "## License Compliance" > license-report.md
          echo "" >> license-report.md

          # Check for license file
          if [ -f LICENSE ] || [ -f LICENSE.txt ] || [ -f LICENSE.md ]; then
            echo "✅ License file found" >> license-report.md
          else
            echo "⚠️ No license file found in repository root" >> license-report.md
          fi

          # Check for copyright headers (basic check)
          echo "" >> license-report.md
          echo "### Copyright Header Check" >> license-report.md

          # Check Go files
          if find . -name "*.go" -not -path "./vendor/*" | head -1 | grep -q .; then
            MISSING_GO=$(find . -name "*.go" -not -path "./vendor/*" -exec grep -L "Copyright" {} \; | wc -l)
            TOTAL_GO=$(find . -name "*.go" -not -path "./vendor/*" | wc -l)
            echo "Go files with copyright headers: $((TOTAL_GO - MISSING_GO))/$TOTAL_GO" >> license-report.md
          fi

          # Check Python files
          if find . -name "*.py" -not -path "./venv/*" | head -1 | grep -q .; then
            MISSING_PY=$(find . -name "*.py" -not -path "./venv/*" -exec grep -L "Copyright\|copyright" {} \; | wc -l)
            TOTAL_PY=$(find . -name "*.py" -not -path "./venv/*" | wc -l)
            echo "Python files with copyright headers: $((TOTAL_PY - MISSING_PY))/$TOTAL_PY" >> license-report.md
          fi

      - name: Upload license report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: maintenance-license-report
          path: license-report.md

  # Commit maintenance changes if requested
  commit-changes:
    name: Commit Maintenance Changes
    needs: [dependency-updates, cleanup-tasks, license-check]
    if: inputs.auto-commit && always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Check for changes
        id: changes
        run: |
          if ! git diff --quiet; then
            echo "changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.changes.outputs.changes == 'true'
        run: |
          git add .
          git commit -m "chore(maintenance): automated repository maintenance

          - Updated dependencies
          - Cleaned up temporary files
          - Ran maintenance tasks

          Generated by automated maintenance workflow"
          git push

  # Maintenance summary
  maintenance-summary:
    name: Maintenance Summary
    needs: [dependency-updates, cleanup-tasks, license-check, commit-changes]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download all reports
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          pattern: maintenance-*-report
          merge-multiple: true

      - name: Generate summary
        env:
          RESULT_DEPENDENCY: ${{ needs.dependency-updates.result || 'skipped' }}
          RESULT_CLEANUP: ${{ needs.cleanup-tasks.result || 'skipped' }}
          RESULT_LICENSE: ${{ needs.license-check.result || 'skipped' }}
          RESULT_COMMIT: ${{ needs.commit-changes.result || 'skipped' }}
        run: |
          {
            printf '## Maintenance Summary\n\n'
            printf '| Task | Status |\n'
            printf '|------|--------|\n'
            printf '| Dependency Updates | %s |\n' "$RESULT_DEPENDENCY"
            printf '| Cleanup Tasks | %s |\n' "$RESULT_CLEANUP"
            printf '| License Check | %s |\n' "$RESULT_LICENSE"
            printf '| Auto Commit | %s |\n' "$RESULT_COMMIT"
            printf '\n'
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -f maintenance-report.md ]; then
            {
              printf '### Dependency Report\n'
              cat maintenance-report.md
              printf '\n'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -f cleanup-report.md ]; then
            {
              printf '### Cleanup Report\n'
              cat cleanup-report.md
              printf '\n'
            } >> "$GITHUB_STEP_SUMMARY"
          fi

          if [ -f license-report.md ]; then
            {
              printf '### License Report\n'
              cat license-report.md
              printf '\n'
            } >> "$GITHUB_STEP_SUMMARY"
          fi
