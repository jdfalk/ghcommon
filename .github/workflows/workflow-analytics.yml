# file: .github/workflows/workflow-analytics.yml
# version: 1.0.3
# guid: f6a7b8c9-d0e1-2f3a-4b5c-6d7e8f9a0b1c

name: Workflow Analytics

on:
  workflow_dispatch:
    inputs:
      lookback-days:
        description: Number of days to analyze (default 30).
        required: false
        default: '30'
        type: string
  schedule:
    - cron: '0 3 * * 1'

permissions:
  actions: read
  contents: read

jobs:
  analytics:
    name: Collect Workflow Analytics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: '3.13'

      - name: Collect workflow metrics
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          LOOKBACK="${{ github.event.inputs.lookback-days }}"
          if [ -z "$LOOKBACK" ]; then
            LOOKBACK=30
          fi
          python .github/workflows/scripts/automation_workflow.py collect-metrics \
            --repo "$GITHUB_REPOSITORY" \
            --token "$GH_TOKEN" \
            --pages 5 \
            --lookback-days "$LOOKBACK" \
            --output analytics-report.json

      - name: Generate analytics summary
        run: python .github/workflows/scripts/generate_workflow_analytics_summary.py

      - name: Append summary to workflow run
        run: |
          cat workflow-analytics.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload analytics artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: workflow-analytics
          path: |
            analytics-report.json
            workflow-analytics.md
          retention-days: 30
