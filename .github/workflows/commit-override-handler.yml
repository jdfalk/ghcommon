# file: .github/workflows/commit-override-handler.yml
# version: 1.1.2
# guid: 7a8b9c0d-1e2f-3456-789a-bcdef0123456

# ‚ö†Ô∏è  DO NOT EDIT DIRECTLY - This file is managed in ghcommon repository
# All changes should be made in jdfalk/ghcommon and will be synced to other repositories
# Edit this file at: https://github.com/jdfalk/ghcommon/edit/main/.github/workflows/commit-override-handler.yml

name: Commit Override Handler

on:
  workflow_call:
    outputs:
      skip-tests:
        description: "Whether to skip test execution"
        value: ${{ jobs.check-overrides.outputs.skip-tests }}
      skip-validation:
        description: "Whether to skip validation/linting"
        value: ${{ jobs.check-overrides.outputs.skip-validation }}
      skip-ci:
        description: "Whether to skip CI entirely"
        value: ${{ jobs.check-overrides.outputs.skip-ci }}
      skip-build:
        description: "Whether to skip build steps"
        value: ${{ jobs.check-overrides.outputs.skip-build }}
      commit-message:
        description: "The commit message(s) analyzed"
        value: ${{ jobs.check-overrides.outputs.commit-message }}
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

permissions:
  contents: read
  actions: read

jobs:
  check-overrides:
    name: Check Commit Overrides
    runs-on: ubuntu-latest
    outputs:
      skip-tests: ${{ steps.check.outputs.skip-tests }}
      skip-validation: ${{ steps.check.outputs.skip-validation }}
      skip-ci: ${{ steps.check.outputs.skip-ci }}
      skip-build: ${{ steps.check.outputs.skip-build }}
      commit-message: ${{ steps.check.outputs.commit-message }}
    steps:
      # NOTE: fetch-depth set to 0 and explicit base branch fetch added to prevent
      # 'fatal: bad revision' / exit 128 errors when computing commit range
      # on PRs. (Previously the job failed before producing outputs.)
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          # Need full history (or at least all commits in PR) plus base branch ref for range comparisons
          fetch-depth: 0

      - name: Fetch base branch ref
        if: ${{ github.event_name == 'pull_request' }}
        run: |
          # Ensure the base branch ref exists locally; without this git log origin/<base>..HEAD fails (exit 128)
          git fetch --no-tags --depth=1 origin "${{ github.event.repository.default_branch }}"
          echo "Fetched base branch ${{ github.event.repository.default_branch }} for comparison"

      - name: Check commit messages for override keywords
        id: check
        run: |
          echo "Checking commit messages for override keywords..."

          # Determine base branch ref (prefer PR base if available)
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          if [ -z "$BASE_BRANCH" ] || [ "$BASE_BRANCH" = "null" ]; then
            BASE_BRANCH="${{ github.event.repository.default_branch }}"
          fi

          # Attempt to gather commit messages relative to base; fall back gracefully on errors
          set +e
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            COMMITS=$(git log --pretty=format:"%s" origin/$BASE_BRANCH..HEAD 2>/dev/null)
            STATUS=$?
            if [ $STATUS -ne 0 ] || [ -z "$COMMITS" ]; then
              echo "‚ö†Ô∏è  Unable to compute commit range origin/$BASE_BRANCH..HEAD (exit $STATUS). Falling back to last 20 commits on HEAD."
              COMMITS=$(git log --pretty=format:"%s" -n 20)
            fi
          else
            COMMITS=$(git log --pretty=format:"%s" -1)
          fi
          set -e

          echo "Commit messages to check:"
          echo "$COMMITS"
          echo ""

          # Check for skip patterns (case insensitive)
          SKIP_TESTS="false"
          SKIP_VALIDATION="false"
          SKIP_CI="false"
          SKIP_BUILD="false"

          # Skip tests patterns
          if echo "$COMMITS" | grep -iE "\[skip.?tests?\]|\[no.?tests?\]|SKIP.?TESTS?|NO.?TESTS?" > /dev/null; then
            SKIP_TESTS="true"
            echo "üö´ SKIP TESTS detected in commit message"
          fi

          # Skip validation patterns
          if echo "$COMMITS" | grep -iE "\[skip.?validation\]|\[no.?validation\]|SKIP.?VALIDATION|NO.?VALIDATION|\[skip.?lint\]|\[no.?lint\]|SKIP.?LINT|NO.?LINT" > /dev/null; then
            SKIP_VALIDATION="true"
            echo "üö´ SKIP VALIDATION detected in commit message"
          fi

          # Skip CI patterns
          if echo "$COMMITS" | grep -iE "\[skip.?ci\]|\[ci.?skip\]|SKIP.?CI|CI.?SKIP|\[skip.?actions\]" > /dev/null; then
            SKIP_CI="true"
            echo "üö´ SKIP CI detected in commit message"
          fi

          # Skip build patterns
          if echo "$COMMITS" | grep -iE "\[skip.?build\]|\[no.?build\]|SKIP.?BUILD|NO.?BUILD" > /dev/null; then
            SKIP_BUILD="true"
            echo "üö´ SKIP BUILD detected in commit message"
          fi

          # Output results
          echo "skip-tests=$SKIP_TESTS" >> $GITHUB_OUTPUT
          echo "skip-validation=$SKIP_VALIDATION" >> $GITHUB_OUTPUT
          echo "skip-ci=$SKIP_CI" >> $GITHUB_OUTPUT
          echo "skip-build=$SKIP_BUILD" >> $GITHUB_OUTPUT
          echo "commit-message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Summary
          echo "## üîç Commit Override Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Override Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Tests | $SKIP_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Validation | $SKIP_VALIDATION |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip CI | $SKIP_CI |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Build | $SKIP_BUILD |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SKIP_TESTS" = "true" ] || [ "$SKIP_VALIDATION" = "true" ] || [ "$SKIP_CI" = "true" ] || [ "$SKIP_BUILD" = "true" ]; then
            echo "‚ö†Ô∏è **Warning**: Some CI checks have been disabled via commit message overrides." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Commit Messages Analyzed:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$COMMITS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All CI checks enabled** - No override keywords detected." >> $GITHUB_STEP_SUMMARY
          fi

  # This job can be referenced by other workflows to conditionally skip steps
  notify-overrides:
    name: Notify Override Status
    runs-on: ubuntu-latest
    needs: check-overrides
    if: needs.check-overrides.outputs.skip-ci != 'true'
    steps:
      - name: Display override status
        run: |
          echo "## üéõÔ∏è CI Override Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following overrides are active for this workflow:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-overrides.outputs.skip-tests }}" = "true" ]; then
            echo "- üö´ **Tests will be skipped**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ **Tests will run normally**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-overrides.outputs.skip-validation }}" = "true" ]; then
            echo "- üö´ **Validation/Linting will be skipped**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ **Validation/Linting will run normally**" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.check-overrides.outputs.skip-build }}" = "true" ]; then
            echo "- üö´ **Build steps will be skipped**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ **Build steps will run normally**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Override Keywords" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Use these in your commit messages to control CI behavior:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Tests**: `[skip tests]`, `[no tests]`, `SKIP TESTS`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Validation**: `[skip validation]`, `[skip lint]`, `SKIP VALIDATION`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip CI**: `[skip ci]`, `[ci skip]`, `SKIP CI`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Build**: `[skip build]`, `[no build]`, `SKIP BUILD`" >> $GITHUB_STEP_SUMMARY
