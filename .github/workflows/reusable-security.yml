# file: .github/workflows/reusable-security.yml
# version: 1.2.5
# guid: reusable-security-2025-09-24-core-workflow

name: Reusable Security Workflow

on:
  workflow_call:
    inputs:
      skip-codeql:
        description: 'Skip CodeQL analysis'
        required: false
        type: boolean
        default: false
      skip-dependency-review:
        description: 'Skip dependency review'
        required: false
        type: boolean
        default: false
      skip-security-audit:
        description: 'Skip security audit'
        required: false
        type: boolean
        default: false
      languages:
        description: 'Languages for CodeQL analysis (JSON array)'
        required: false
        type: string
        default: '["go", "javascript", "python", "github-actions"]'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # Detect available languages
  detect-languages:
    name: Detect Languages
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
      has-languages: ${{ steps.detect.outputs.has-languages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Checkout ghcommon scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: jdfalk/ghcommon
          ref: main
          path: .ghcommon
          sparse-checkout: |
            .github/scripts

      - name: Detect available languages
        id: detect
        run: |
          python3 .ghcommon/.github/scripts/determine-security-languages.py

  # CodeQL Analysis — advanced mode with per-language build control.
  # Languages that require compilation (go, javascript) use autobuild.
  # Static-only languages (python, github-actions) use build-mode: none.
  # start-proxy is included for future registry-proxy support even when
  # not actively routing traffic.
  codeql-analysis:
    name: CodeQL Analysis (${{ matrix.language }})
    needs: detect-languages
    if: ${{ !inputs.skip-codeql && needs.detect-languages.outputs.has-languages == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(needs.detect-languages.outputs.languages) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine build mode for language
        id: build-config
        run: |
          case "${{ matrix.language }}" in
            go|javascript)
              echo "mode=autobuild" >> "$GITHUB_OUTPUT"
              ;;
            python|github-actions|*)
              echo "mode=none" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Initialize CodeQL
        uses: github/codeql-action/init@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
          build-mode: ${{ steps.build-config.outputs.mode }}

      - name: Set up language environment
        run: |
          case "${{ matrix.language }}" in
            go)
              if [ -f go.mod ]; then
                go mod download
              fi
              ;;
            javascript)
              # Locate package.json — may be in a subdirectory (e.g. web/)
              # Read working_directories.node from repository-config.yml if present
              NODE_DIR="."
              if [ -f .github/repository-config.yml ]; then
                CONFIGURED=$(grep -A1 "node:" .github/repository-config.yml | grep -v "node:" | tr -d ' ' | head -1)
                if [ -n "$CONFIGURED" ] && [ -d "$CONFIGURED" ]; then
                  NODE_DIR="$CONFIGURED"
                fi
              fi
              if [ -f "$NODE_DIR/package.json" ]; then
                cd "$NODE_DIR" && npm ci --ignore-scripts
              fi
              ;;
            python)
              if [ -f requirements.txt ]; then
                pip install -r requirements.txt
              fi
              ;;
            github-actions)
              # No build environment needed for workflow static analysis
              ;;
          esac

      - name: Start proxy for registry access
        uses: github/codeql-action/start-proxy@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1

      - name: Autobuild
        if: steps.build-config.outputs.mode == 'autobuild'
        uses: github/codeql-action/autobuild@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1
        with:
          category: '/language:${{ matrix.language }}'

      - name: NPM dependency audit
        if: matrix.language == 'javascript'
        run: |
          NODE_DIR="."
          if [ -f .github/repository-config.yml ]; then
            CONFIGURED=$(grep -A1 "node:" .github/repository-config.yml | grep -v "node:" | tr -d ' ' | head -1)
            if [ -n "$CONFIGURED" ] && [ -d "$CONFIGURED" ]; then
              NODE_DIR="$CONFIGURED"
            fi
          fi
          if [ -f "$NODE_DIR/package.json" ]; then
            echo "Running npm audit in $NODE_DIR..."
            cd "$NODE_DIR" && npm audit --audit-level=high || true
          fi

  # Dependency Review
  dependency-review:
    name: Dependency Review
    needs: detect-languages
    if: ${{ !inputs.skip-dependency-review && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for config file
        id: check-config
        run: |
          if [ -f ".github/dependency-review-config.yml" ]; then
            echo "has-config=true" >> "$GITHUB_OUTPUT"
          else
            echo "has-config=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Dependency Review (with config)
        if: steps.check-config.outputs.has-config == 'true'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          config-file: './.github/dependency-review-config.yml'

      - name: Dependency Review (default)
        if: steps.check-config.outputs.has-config == 'false'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: moderate

  # Security Audit
  security-audit:
    name: Security Audit
    needs: detect-languages
    if: ${{ !inputs.skip-security-audit }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Go security audit
        if: hashFiles('go.mod') != ''
        run: |
          # Use gosec instead of go-audit (which is deprecated/unavailable)
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          gosec -fmt json -out gosec-report.json ./... || true
          if [ -f gosec-report.json ]; then
            echo "Gosec security scan completed. Report:"
            cat gosec-report.json
          fi

      - name: Python security audit
        if: hashFiles('requirements*.txt', 'pyproject.toml') != ''
        run: |
          pip install safety bandit
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt
          fi
          if find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | head -1 | grep -q .; then
            bandit -r . -x ./venv,./venv3,./.venv -f json -o bandit-report.json || true
            if [ -f bandit-report.json ]; then
              echo "Bandit security scan completed. Report:"
              cat bandit-report.json
            fi
          fi

      - name: Node.js security audit
        if: hashFiles('package*.json') != ''
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=moderate || true
          fi

      - name: Rust security audit
        if: hashFiles('Cargo.toml') != ''
        run: |
          cargo install cargo-audit
          cargo audit

  # Trivy vulnerability scanning
  trivy-scan:
    name: Trivy Security Scan
    needs: detect-languages
    if: ${{ !inputs.skip-security-audit }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@6bc82e05fd0ea64601dd4b465378bbcf57de0314 # v4.32.1
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Security summary
  security-summary:
    name: Security Summary
    needs:
      - detect-languages
      - codeql-analysis
      - dependency-review
      - security-audit
      - trivy-scan
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ghcommon scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: jdfalk/ghcommon
          ref: main
          path: .ghcommon
          sparse-checkout: |
            .github/scripts

      - name: Generate security summary
        env:
          RESULT_CODEQL: ${{ needs.codeql-analysis.result || 'skipped' }}
          RESULT_DEP_REVIEW: ${{ needs.dependency-review.result || 'skipped' }}
          RESULT_SECURITY_AUDIT: ${{ needs.security-audit.result || 'skipped' }}
          RESULT_TRIVY: ${{ needs.trivy-scan.result || 'skipped' }}
          SKIP_CODEQL: ${{ inputs.skip-codeql }}
          SKIP_DEP_REVIEW: ${{ inputs.skip-dependency-review }}
          SKIP_SECURITY_AUDIT: ${{ inputs.skip-security-audit }}
        run: |
          python3 .ghcommon/.github/scripts/generate-security-summary.py
