# file: .github/workflows/reusable-ci.yml
# version: 1.10.2
# guid: reusable-ci-2025-09-24-core-workflow

name: Reusable CI Workflow

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.24'
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '22'
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.13'
      rust-version:
        description: 'Rust version to use'
        required: false
        type: string
        default: '1.76'
      coverage-threshold:
        description: 'Coverage threshold percentage'
        required: false
        type: string
        default: '80'
      skip-protobuf:
        description: 'Skip protobuf generation'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false
      skip-e2e-tests:
        description: 'Skip running E2E tests'
        required: false
        type: boolean
        default: false
      skip-linting:
        description: 'Skip linting'
        required: false
        type: boolean
        default: false
    outputs:
      go-files:
        description: 'Whether Go files were detected'
        value: ${{ jobs.detect-changes.outputs.go-files }}
      python-files:
        description: 'Whether Python files were detected'
        value: ${{ jobs.detect-changes.outputs.python-files }}
      rust-files:
        description: 'Whether Rust files were detected'
        value: ${{ jobs.detect-changes.outputs.rust-files }}
      frontend-files:
        description: 'Whether frontend files were detected'
        value: ${{ jobs.detect-changes.outputs.frontend-files }}
      docker-files:
        description: 'Whether Docker files were detected'
        value: ${{ jobs.detect-changes.outputs.docker-files }}
      docs-files:
        description: 'Whether documentation files were detected'
        value: ${{ jobs.detect-changes.outputs.docs-files }}
      workflows-files:
        description: 'Whether workflow files were detected'
        value: ${{ jobs.detect-changes.outputs.workflows-files }}
      lint-files:
        description: 'Whether linter configuration files were detected'
        value: ${{ jobs.detect-changes.outputs.lint-files }}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  load-config:
    name: Load Repository Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    outputs:
      config: ${{ steps.load.outputs.config }}
      has-config: ${{ steps.load.outputs.has-config }}
      go-matrix: ${{ steps.matrices.outputs.go-matrix }}
      python-matrix: ${{ steps.matrices.outputs.python-matrix }}
      rust-matrix: ${{ steps.matrices.outputs.rust-matrix }}
      frontend-matrix: ${{ steps.matrices.outputs.frontend-matrix }}
      coverage-threshold: ${{ steps.matrices.outputs.coverage-threshold }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Load repository configuration
        id: load
        uses: jdfalk/load-config-action@98cad3221e6ea1013029a93011860f5d4c5ae660 # v1.1.2
        with:
          config-file: .github/repository-config.yml
          fail-on-missing: false

      - name: Generate language matrices
        id: matrices
        uses: jdfalk/ci-generate-matrices-action@538acf8f83acfccca197cd0bbd433fe1638fc47c # v1.1.5
        with:
          repository-config: ${{ steps.load.outputs.config }}
          fallback-go-version: ${{ inputs.go-version }}
          fallback-python-version: ${{ inputs.python-version }}
          fallback-rust-version: ${{ inputs.rust-version }}
          fallback-node-version: ${{ inputs.node-version }}
          fallback-coverage-threshold: ${{ inputs.coverage-threshold }}

  # Detect what files changed to optimize workflow execution
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    needs: load-config
    outputs:
      go-files: ${{ steps.changes.outputs.go_files }}
      python-files: ${{ steps.changes.outputs.python_files }}
      rust-files: ${{ steps.changes.outputs.rust_files }}
      frontend-files: ${{ steps.changes.outputs.frontend_files }}
      docker-files: ${{ steps.changes.outputs.docker_files }}
      docs-files: ${{ steps.changes.outputs.docs_files }}
      workflow-files: ${{ steps.changes.outputs.workflow_yaml }}
      workflows-files: ${{ steps.changes.outputs.workflow_yaml }}
      workflows-scripts: ${{ steps.changes.outputs.workflow_scripts }}
      lint-files: ${{ steps.changes.outputs.lint_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: changes
        with:
          base: ${{ github.event.pull_request.base.sha || github.event.before || github.sha }}
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          filters: |
            go_files:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            python_files:
              - '**/*.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'setup.py'
              - 'setup.cfg'
            rust_files:
              - '**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
            frontend_files:
              - '**/*.js'
              - '**/*.ts'
              - '**/*.jsx'
              - '**/*.tsx'
              - '**/*.vue'
              - '**/*.svelte'
              - '**/*.html'
              - '**/*.css'
              - '**/*.scss'
              - '**/*.sass'
              - '**/*.less'
              - 'package*.json'
              - 'yarn.lock'
              - 'pnpm-lock.yaml'
            docker_files:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - 'docker-compose*.yaml'
              - '.dockerignore'
            docs_files:
              - '**/*.md'
              - 'docs/**'
              - '*.md'
            workflow_yaml:
              - '.github/workflows/**'
            workflow_scripts:
              - '.github/actions/**'
              - '.github/scripts/**'
            lint_files:
              - 'super-linter-*.env'
              - '.markdownlint.json'
              - '.yaml-lint.yml'
              - 'clippy.toml'
              - 'rustfmt.toml'
              - '.eslintrc.*'
              - '.pylintrc'
              - '.python-black'
              - '.prettierrc*'
              - '.flake8'

      - name: Debug change outputs
        env:
          CI_GO_FILES: ${{ steps.changes.outputs.go_files }}
          CI_PYTHON_FILES: ${{ steps.changes.outputs.python_files }}
          CI_RUST_FILES: ${{ steps.changes.outputs.rust_files }}
          CI_FRONTEND_FILES: ${{ steps.changes.outputs.frontend_files }}
          CI_DOCKER_FILES: ${{ steps.changes.outputs.docker_files }}
          CI_DOCS_FILES: ${{ steps.changes.outputs.docs_files }}
          CI_WORKFLOW_FILES: ${{ steps.changes.outputs.workflow_yaml }}
          CI_WORKFLOW_YAML_FILES: ${{ steps.changes.outputs.workflow_yaml }}
          CI_WORKFLOW_SCRIPT_FILES: ${{ steps.changes.outputs.workflow_scripts }}
          CI_LINT_FILES: ${{ steps.changes.outputs.lint_files }}
        run: |
          {
            printf '## Change Detection\n\n'
            printf -- '- Go files: %s\n' "$CI_GO_FILES"
            printf -- '- Python files: %s\n' "$CI_PYTHON_FILES"
            printf -- '- Rust files: %s\n' "$CI_RUST_FILES"
            printf -- '- Frontend files: %s\n' "$CI_FRONTEND_FILES"
            printf -- '- Docker files: %s\n' "$CI_DOCKER_FILES"
            printf -- '- Docs files: %s\n' "$CI_DOCS_FILES"
            printf -- '- Workflow YAML: %s\n' "$CI_WORKFLOW_FILES"
            printf -- '- Workflow scripts: %s\n' "$CI_WORKFLOW_SCRIPT_FILES"
            printf -- '- Lint files: %s\n' "$CI_LINT_FILES"
          } >> "$GITHUB_STEP_SUMMARY"

  workflow-lint:
    name: Workflow Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.workflow-files == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.23'
          check-latest: true

      - name: Install actionlint
        run: |
          set -euo pipefail
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.1
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Run actionlint
        id: lint
        run: |
          set -euo pipefail
          ACTIONLINT_BIN="$(go env GOPATH)/bin/actionlint"
          "$ACTIONLINT_BIN" -no-color | tee actionlint.log

      - name: Publish workflow summary
        if: always()
        run: |
          {
            printf '## Workflow Lint\n\n'
            if [ -s actionlint.log ]; then
              printf '```text\n'
              cat actionlint.log
              printf '\n```\n'
            else
              printf "✅ No workflow issues detected.\n"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload actionlint log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: workflow-lint-report
          path: actionlint.log
          if-no-files-found: ignore

  # Setup npm cache for workflow-scripts using advanced cache strategy
  workflow-scripts-npm-cache:
    name: Cache npm (Workflow Scripts)
    needs: detect-changes
    if: needs.detect-changes.outputs.workflows-scripts == 'true' || github.event_name == 'workflow_dispatch'
    uses: jdfalk/ghcommon/.github/workflows/reusable-advanced-cache.yml@b904a08523f11927f2fa22c83d349bf471d73ef6 # main
    with:
      language: 'node'
      cache-prefix: 'npm-workflow-scripts'
      include-branch: false

  workflow-scripts:
    name: Workflow Scripts
    needs: [detect-changes, workflow-scripts-npm-cache]
    if: needs.detect-changes.outputs.workflows-scripts == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ inputs.python-version }}

      - name: Lint Python workflow scripts
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install ruff
          if find .github/scripts -maxdepth 1 -name "*.py" | head -n 1 | grep -q .; then
            ruff check .github/scripts
            ruff format --check .github/scripts
            python -m compileall .github/scripts
          else
            echo "No Python workflow scripts detected."
          fi

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}

      # Cache has been prepared by workflow-scripts-npm-cache job using reusable-advanced-cache.yml
      # This leverages intelligent cache key generation based on package-lock.json, yarn.lock, and pnpm-lock.yaml
      # No additional cache setup needed here.

      - name: Lint JavaScript/TypeScript workflow scripts
        run: |
          set -euo pipefail
          mapfile -d '' -t js_ts_files < <(find .github -type f \( -path "./.github/scripts/*" -o -path "./.github/actions/*" \) \( -name "*.js" -o -name "*.ts" -o -name "*.tsx" \) -print0)
          if [ "${#js_ts_files[@]}" -gt 0 ]; then
            directories=(".github/scripts")
            if [ -d ".github/actions" ]; then
              directories+=(".github/actions")
            fi
            npx --yes eslint@9.13.0 --config .eslintrc.yml --ext .js,.ts,.tsx "${directories[@]}"
            printf '%s\0' "${js_ts_files[@]}" | xargs -0 npx --yes prettier@3.3.3 --check
          else
            echo "No JavaScript/TypeScript workflow scripts detected."
          fi

      - name: Publish workflow script summary
        if: always()
        run: |
          {
            printf '## Workflow Script Lint\n\n'
            printf -- '- Python scripts linted and formatted with Ruff.\n'
            printf -- '- JavaScript/TypeScript scripts linted with ESLint and checked with Prettier.\n'
          } >> "$GITHUB_STEP_SUMMARY"

  # Protobuf generation (if applicable)
  protobuf-generation:
    name: Generate Protobuf
    if: |
      !inputs.skip-protobuf &&
      (contains(github.event.head_commit.message, '[protobuf]') ||
       contains(github.event.head_commit.message, '[generate]') ||
       contains(github.event.head_commit.message, '[buf]'))
    uses: jdfalk/ghcommon/.github/workflows/reusable-protobuf.yml@bc6380dd1cfb1a3b8eb24c27d6cfe4a887562b5b # main
    secrets: inherit

  # Language-specific build and test jobs
  go-ci:
    name: Go CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.go-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.go-matrix) }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" || "$ref" == refs/pull/* ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Build Go project
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: go-setup

      - name: Test Go project
        if: ${{ !inputs.skip-tests }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: go-test
          coverage-threshold: ${{ inputs.coverage-threshold || needs.load-config.outputs.coverage-threshold }}

      - name: Generate Go coverage profile
        if: ${{ !inputs.skip-tests }}
        continue-on-error: true
        run: go test ./... -coverprofile=./cover.out -covermode=atomic -coverpkg=./...

      - name: Check Go test coverage
        if: ${{ !inputs.skip-tests }}
        continue-on-error: true
        uses: vladopajic/go-test-coverage@679e6807f68f2440a4c43d386442a1d0041838a9 # v2.18.3
        with:
          config: ./.testcoverage.yml

  python-ci:
    name: Python CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.python-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.python-matrix) }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" || "$ref" == refs/pull/* ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Install Python dependencies
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: python-install

      - name: Lint Python code
        if: ${{ !inputs.skip-linting }}
        run: |
          python "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" python-lint

      - name: Test Python code
        if: ${{ !inputs.skip-tests }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: python-run-tests

  rust-ci:
    name: Rust CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.rust-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.rust-matrix) }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    permissions:
      contents: read
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: ${{ matrix.rust-version }}
          components: rustfmt, clippy

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" || "$ref" == refs/pull/* ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Cache Rust dependencies
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Format Rust code
        if: ${{ !inputs.skip-linting }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: rust-format

      - name: Lint Rust code
        if: ${{ !inputs.skip-linting }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: rust-clippy

      - name: Build Rust project
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: rust-build

      - name: Test Rust project
        if: ${{ !inputs.skip-tests }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: rust-test

  # Setup npm cache for frontend using advanced cache strategy
  frontend-npm-cache:
    name: Cache npm (Frontend)
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-files == 'true'
    uses: jdfalk/ghcommon/.github/workflows/reusable-advanced-cache.yml@b904a08523f11927f2fa22c83d349bf471d73ef6 # main
    with:
      language: 'node'
      cache-prefix: 'npm-frontend'
      include-branch: false

  frontend-ci:
    name: Frontend CI
    needs: [load-config, detect-changes, frontend-npm-cache]
    if: needs.detect-changes.outputs.frontend-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.frontend-matrix) }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Get frontend working directory
        id: frontend-dir
        uses: jdfalk/get-frontend-config-action@c48769f8cfde4b3c83f797d585bf87a11f606a6a # v1.1.2
        with:
          repository-config: ${{ env.REPOSITORY_CONFIG }}

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" || "$ref" == refs/pull/* ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ matrix.node-version }}

      # Cache has been prepared by frontend-npm-cache job using reusable-advanced-cache.yml
      # This leverages intelligent cache key generation based on package-lock.json in the frontend directory
      # No additional cache setup needed here.

      - name: Install dependencies
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: frontend-install
          frontend-working-dir: ${{ steps.frontend-dir.outputs.dir }}

      - name: Lint frontend code
        if: ${{ !inputs.skip-linting }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: frontend-run
          frontend-working-dir: ${{ steps.frontend-dir.outputs.dir }}
          frontend-script: lint
          frontend-success-message: '✅ Linting passed'
          frontend-failure-message: '❌ Linting failed or not configured'

      - name: Build frontend
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: frontend-run
          frontend-working-dir: ${{ steps.frontend-dir.outputs.dir }}
          frontend-script: build
          frontend-success-message: '✅ Build successful'
          frontend-failure-message: 'ℹ️ No build script configured'

      - name: Test frontend
        if: ${{ !inputs.skip-tests }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: frontend-run
          frontend-working-dir: ${{ steps.frontend-dir.outputs.dir }}
          frontend-script: test
          frontend-success-message: '✅ Tests passed'
          frontend-failure-message: 'ℹ️ No tests configured'

      # E2E Tests with Playwright
      - name: Install Playwright browsers
        if: ${{ !inputs.skip-tests && !inputs.skip-e2e-tests }}
        run: |
          cd "${{ steps.frontend-dir.outputs.dir }}"
          sudo npx playwright install --with-deps chromium webkit
        shell: bash

      - name: Run E2E tests
        if: ${{ !inputs.skip-tests && !inputs.skip-e2e-tests }}
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: frontend-run
          frontend-working-dir: ${{ steps.frontend-dir.outputs.dir }}
          frontend-script: test:e2e
          frontend-success-message: '✅ E2E tests passed'
          frontend-failure-message: 'ℹ️ No E2E tests configured or test:e2e script not found'
        continue-on-error: false

      - name: Upload Playwright report
        if: ${{ !inputs.skip-tests && !inputs.skip-e2e-tests && always() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-report-${{ matrix.os }}-node-${{ matrix.node-version }}
          path: ${{ steps.frontend-dir.outputs.dir }}/playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Playwright test results
        if: ${{ !inputs.skip-tests && !inputs.skip-e2e-tests && always() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-results-${{ matrix.os }}-node-${{ matrix.node-version }}
          path: ${{ steps.frontend-dir.outputs.dir }}/test-results/
          retention-days: 7
          if-no-files-found: ignore

  # Summary job
  ci-summary:
    name: CI Summary
    needs:
      [
        detect-changes,
        workflow-lint,
        workflow-scripts,
        workflow-scripts-npm-cache,
        go-ci,
        python-ci,
        rust-ci,
        frontend-ci,
        frontend-npm-cache,
      ]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" || "$ref" == refs/pull/* ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Set environment variables for summary
        run: |
          {
            echo "CI_GO_FILES=${{ needs.detect-changes.outputs.go-files }}"
            echo "CI_PYTHON_FILES=${{ needs.detect-changes.outputs.python-files }}"
            echo "CI_RUST_FILES=${{ needs.detect-changes.outputs.rust-files }}"
            echo "CI_FRONTEND_FILES=${{ needs.detect-changes.outputs.frontend-files }}"
            echo "CI_DOCKER_FILES=${{ needs.detect-changes.outputs.docker-files }}"
            echo "CI_DOCS_FILES=${{ needs.detect-changes.outputs.docs-files }}"
            echo "CI_WORKFLOW_FILES=${{ needs.detect-changes.outputs.workflow-files }}"
            echo "CI_WORKFLOW_YAML_FILES=${{ needs.detect-changes.outputs.workflows-files }}"
            echo "CI_WORKFLOW_SCRIPT_FILES=${{ needs.detect-changes.outputs.workflows-scripts }}"
            echo "CI_LINT_FILES=${{ needs.detect-changes.outputs.lint-files }}"
          } >> "$GITHUB_ENV"

      - name: Generate summary
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: generate-ci-summary
        env:
          JOB_DETECT_CHANGES: ${{ needs.detect-changes.result || 'skipped' }}
          JOB_WORKFLOW_LINT: ${{ needs.workflow-lint.result || 'skipped' }}
          JOB_WORKFLOW_SCRIPTS: ${{ needs.workflow-scripts.result || 'skipped' }}
          JOB_GO: ${{ needs.go-ci.result || 'skipped' }}
          JOB_PYTHON: ${{ needs.python-ci.result || 'skipped' }}
          JOB_RUST: ${{ needs.rust-ci.result || 'skipped' }}
          JOB_FRONTEND: ${{ needs.frontend-ci.result || 'skipped' }}
          JOB_DOCKER: skipped
          JOB_DOCS: skipped

      - name: Check overall status
        uses: jdfalk/ci-workflow-helpers-action@71e09093947c478e54a01855baf76a43f36843a4 # v1.1.3
        with:
          command: check-ci-status
        env:
          JOB_WORKFLOW_LINT: ${{ needs.workflow-lint.result || 'skipped' }}
          JOB_WORKFLOW_SCRIPTS: ${{ needs.workflow-scripts.result || 'skipped' }}
          JOB_GO: ${{ needs.go-ci.result || 'skipped' }}
          JOB_PYTHON: ${{ needs.python-ci.result || 'skipped' }}
          JOB_RUST: ${{ needs.rust-ci.result || 'skipped' }}
          JOB_FRONTEND: ${{ needs.frontend-ci.result || 'skipped' }}
          JOB_DOCKER: skipped
          JOB_DOCS: skipped
