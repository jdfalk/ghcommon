# file: .github/workflows/reusable-ci.yml
# version: 1.5.0
# guid: reusable-ci-2025-09-24-core-workflow

name: Reusable CI Workflow

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version to use'
        required: false
        type: string
        default: '1.24'
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '22'
      python-version:
        description: 'Python version to use'
        required: false
        type: string
        default: '3.13'
      rust-version:
        description: 'Rust version to use'
        required: false
        type: string
        default: '1.76'
      coverage-threshold:
        description: 'Coverage threshold percentage'
        required: false
        type: string
        default: '80'
      skip-protobuf:
        description: 'Skip protobuf generation'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false
      skip-linting:
        description: 'Skip linting'
        required: false
        type: boolean
        default: false
    outputs:
      go-files:
        description: 'Whether Go files were detected'
        value: ${{ jobs.detect-changes.outputs.go-files }}
      python-files:
        description: 'Whether Python files were detected'
        value: ${{ jobs.detect-changes.outputs.python-files }}
      rust-files:
        description: 'Whether Rust files were detected'
        value: ${{ jobs.detect-changes.outputs.rust-files }}
      frontend-files:
        description: 'Whether frontend files were detected'
        value: ${{ jobs.detect-changes.outputs.frontend-files }}
      docker-files:
        description: 'Whether Docker files were detected'
        value: ${{ jobs.detect-changes.outputs.docker-files }}
      docs-files:
        description: 'Whether documentation files were detected'
        value: ${{ jobs.detect-changes.outputs.docs-files }}
      workflows-files:
        description: 'Whether workflow files were detected'
        value: ${{ jobs.detect-changes.outputs.workflows-files }}
      lint-files:
        description: 'Whether linter configuration files were detected'
        value: ${{ jobs.detect-changes.outputs.lint-files }}

permissions:
  contents: write
  actions: write
  checks: write
  packages: write
  security-events: write
  id-token: write
  attestations: write

jobs:
  load-config:
    name: Load Repository Configuration
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.load.outputs.config }}
      has-config: ${{ steps.load.outputs.has-config }}
      go-matrix: ${{ steps.matrices.outputs.go-matrix }}
      python-matrix: ${{ steps.matrices.outputs.python-matrix }}
      rust-matrix: ${{ steps.matrices.outputs.rust-matrix }}
      frontend-matrix: ${{ steps.matrices.outputs.frontend-matrix }}
      coverage-threshold: ${{ steps.matrices.outputs.coverage-threshold }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@v6
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Load repository configuration
        id: load
        env:
          CONFIG_FILE: .github/repository-config.yml
        run: python3 "$GHCOMMON_SCRIPTS_DIR/load_repository_config.py"

      - name: Generate language matrices
        id: matrices
        env:
          REPOSITORY_CONFIG: ${{ steps.load.outputs.config }}
          FALLBACK_GO_VERSION: ${{ inputs.go-version }}
          FALLBACK_PYTHON_VERSION: ${{ inputs.python-version }}
          FALLBACK_RUST_VERSION: ${{ inputs.rust-version }}
          FALLBACK_NODE_VERSION: ${{ inputs.node-version }}
          FALLBACK_COVERAGE_THRESHOLD: ${{ inputs.coverage-threshold }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" generate-matrices

  # Detect what files changed to optimize workflow execution
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    needs: load-config
    outputs:
      go-files: ${{ steps.changes.outputs.go_files }}
      python-files: ${{ steps.changes.outputs.python_files }}
      rust-files: ${{ steps.changes.outputs.rust_files }}
      frontend-files: ${{ steps.changes.outputs.frontend_files }}
      docker-files: ${{ steps.changes.outputs.docker_files }}
      docs-files: ${{ steps.changes.outputs.docs_files }}
      workflow-files: ${{ steps.changes.outputs.workflow_yaml }}
      workflows-files: ${{ steps.changes.outputs.workflow_yaml }}
      workflows-scripts: ${{ steps.changes.outputs.workflow_scripts }}
      lint-files: ${{ steps.changes.outputs.lint_files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            go_files:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            python_files:
              - '**/*.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'setup.py'
              - 'setup.cfg'
            rust_files:
              - '**/*.rs'
              - 'Cargo.toml'
              - 'Cargo.lock'
            frontend_files:
              - '**/*.js'
              - '**/*.ts'
              - '**/*.jsx'
              - '**/*.tsx'
              - '**/*.vue'
              - '**/*.svelte'
              - '**/*.html'
              - '**/*.css'
              - '**/*.scss'
              - '**/*.sass'
              - '**/*.less'
              - 'package*.json'
              - 'yarn.lock'
              - 'pnpm-lock.yaml'
            docker_files:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - 'docker-compose*.yaml'
              - '.dockerignore'
            docs_files:
              - '**/*.md'
              - 'docs/**'
              - '*.md'
            workflow_yaml:
              - '.github/workflows/**'
            workflow_scripts:
              - '.github/actions/**'
              - '.github/scripts/**'
            lint_files:
              - 'super-linter-*.env'
              - '.markdownlint.json'
              - '.yaml-lint.yml'
              - 'clippy.toml'
              - 'rustfmt.toml'
              - '.eslintrc.*'
              - '.pylintrc'
              - '.python-black'
              - '.prettierrc*'
              - '.flake8'

      - name: Debug change outputs
        env:
          CI_GO_FILES: ${{ steps.changes.outputs.go_files }}
          CI_PYTHON_FILES: ${{ steps.changes.outputs.python_files }}
          CI_RUST_FILES: ${{ steps.changes.outputs.rust_files }}
          CI_FRONTEND_FILES: ${{ steps.changes.outputs.frontend_files }}
          CI_DOCKER_FILES: ${{ steps.changes.outputs.docker_files }}
          CI_DOCS_FILES: ${{ steps.changes.outputs.docs_files }}
          CI_WORKFLOW_FILES: ${{ steps.changes.outputs.workflow_yaml }}
          CI_WORKFLOW_YAML_FILES: ${{ steps.changes.outputs.workflow_yaml }}
          CI_WORKFLOW_SCRIPT_FILES: ${{ steps.changes.outputs.workflow_scripts }}
          CI_LINT_FILES: ${{ steps.changes.outputs.lint_files }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" debug-filter

  workflow-lint:
    name: Workflow Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.workflow-files == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.23'
          check-latest: true

      - name: Install actionlint
        run: |
          set -euo pipefail
          go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.1
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - name: Run actionlint
        id: lint
        run: |
          set -euo pipefail
          ACTIONLINT_BIN="$(go env GOPATH)/bin/actionlint"
          "$ACTIONLINT_BIN" -no-color | tee actionlint.log

      - name: Publish workflow summary
        if: always()
        run: |
          {
            printf '## Workflow Lint\n\n'
            if [ -s actionlint.log ]; then
              printf '```text\n'
              cat actionlint.log
              printf '\n```\n'
            else
              printf "✅ No workflow issues detected.\n"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload actionlint log
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: workflow-lint-report
          path: actionlint.log
          if-no-files-found: ignore

  workflow-scripts:
    name: Workflow Scripts
    needs: detect-changes
    if: needs.detect-changes.outputs.workflows-scripts == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}

      - name: Lint Python workflow scripts
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install ruff
          if find .github/scripts -maxdepth 1 -name "*.py" | head -n 1 | grep -q .; then
            ruff check .github/scripts
            ruff format --check .github/scripts
            python -m compileall .github/scripts
          else
            echo "No Python workflow scripts detected."
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Lint JavaScript/TypeScript workflow scripts
        run: |
          set -euo pipefail
          mapfile -d '' -t js_ts_files < <(find .github -type f \( -path "./.github/scripts/*" -o -path "./.github/actions/*" \) \( -name "*.js" -o -name "*.ts" -o -name "*.tsx" \) -print0)
          if [ "${#js_ts_files[@]}" -gt 0 ]; then
            directories=(".github/scripts")
            if [ -d ".github/actions" ]; then
              directories+=(".github/actions")
            fi
            npx --yes eslint@9.13.0 --config .eslintrc.yml --ext .js,.ts,.tsx "${directories[@]}"
            printf '%s\0' "${js_ts_files[@]}" | xargs -0 npx --yes prettier@3.3.3 --check
          else
            echo "No JavaScript/TypeScript workflow scripts detected."
          fi

      - name: Publish workflow script summary
        if: always()
        run: |
          {
            printf '## Workflow Script Lint\n\n'
            printf '- Python scripts linted and formatted with Ruff.\n'
            printf '- JavaScript/TypeScript scripts linted with ESLint and checked with Prettier.\n'
          } >> "$GITHUB_STEP_SUMMARY"

  # Protobuf generation (if applicable)
  protobuf-generation:
    name: Generate Protobuf
    if: |
      !inputs.skip-protobuf &&
      (contains(github.event.head_commit.message, '[protobuf]') ||
       contains(github.event.head_commit.message, '[generate]') ||
       contains(github.event.head_commit.message, '[buf]'))
    uses: jdfalk/ghcommon/.github/workflows/reusable-protobuf.yml@main
    secrets: inherit

  # Language-specific build and test jobs
  go-ci:
    name: Go CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.go-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.go-matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true

      - name: Build Go project
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" go-setup

      - name: Test Go project
        if: ${{ !inputs.skip-tests }}
        env:
          COVERAGE_THRESHOLD: ${{ inputs.coverage-threshold || needs.load-config.outputs.coverage-threshold }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" go-test

  python-ci:
    name: Python CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.python-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.python-matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install Python dependencies
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" python-install

      - name: Lint Python code
        if: ${{ !inputs.skip-linting }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" python-lint

      - name: Test Python code
        if: ${{ !inputs.skip-tests }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" python-run-tests

  rust-ci:
    name: Rust CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.rust-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.rust-matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust-version }}
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Format Rust code
        if: ${{ !inputs.skip-linting }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" rust-format

      - name: Lint Rust code
        if: ${{ !inputs.skip-linting }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" rust-clippy

      - name: Build Rust project
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" rust-build

      - name: Test Rust project
        if: ${{ !inputs.skip-tests }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" rust-test

  frontend-ci:
    name: Frontend CI
    needs: [load-config, detect-changes]
    if: needs.detect-changes.outputs.frontend-files == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.load-config.outputs.frontend-matrix) }}
    runs-on: ${{ matrix.os }}
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get frontend working directory
        id: frontend-dir
        run: |
          WORKING_DIR=$(echo '${{ needs.load-config.outputs.config }}' | python3 -c "import sys, json; config = json.load(sys.stdin); print(config.get('working_directories', {}).get('frontend', '.'))") || echo "."
          echo "dir=${WORKING_DIR}" >> $GITHUB_OUTPUT
          if [ "${WORKING_DIR}" != "." ]; then
            echo "cache-path=${WORKING_DIR}/package-lock.json" >> $GITHUB_OUTPUT
          else
            echo "cache-path=package-lock.json" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
          cache-dependency-path: ${{ steps.frontend-dir.outputs.cache-path }}

      - name: Install dependencies
        env:
          FRONTEND_WORKING_DIR: ${{ steps.frontend-dir.outputs.dir }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" frontend-install

      - name: Lint frontend code
        if: ${{ !inputs.skip-linting }}
        env:
          FRONTEND_WORKING_DIR: ${{ steps.frontend-dir.outputs.dir }}
          FRONTEND_SCRIPT: lint
          FRONTEND_SUCCESS_MESSAGE: '✅ Linting passed'
          FRONTEND_FAILURE_MESSAGE: '❌ Linting failed or not configured'
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" frontend-run

      - name: Build frontend
        env:
          FRONTEND_WORKING_DIR: ${{ steps.frontend-dir.outputs.dir }}
          FRONTEND_SCRIPT: build
          FRONTEND_SUCCESS_MESSAGE: '✅ Build successful'
          FRONTEND_FAILURE_MESSAGE: 'ℹ️ No build script configured'
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" frontend-run

      - name: Test frontend
        if: ${{ !inputs.skip-tests }}
        env:
          FRONTEND_WORKING_DIR: ${{ steps.frontend-dir.outputs.dir }}
          FRONTEND_SCRIPT: test
          FRONTEND_SUCCESS_MESSAGE: '✅ Tests passed'
          FRONTEND_FAILURE_MESSAGE: 'ℹ️ No tests configured'
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" frontend-run

  # Summary job
  ci-summary:
    name: CI Summary
    needs:
      [
        detect-changes,
        workflow-lint,
        workflow-scripts,
        go-ci,
        python-ci,
        rust-ci,
        frontend-ci,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Generate summary
        env:
          JOB_DETECT_CHANGES: ${{ needs.detect-changes.result || 'skipped' }}
          JOB_WORKFLOW_LINT: ${{ needs.workflow-lint.result || 'skipped' }}
          JOB_WORKFLOW_SCRIPTS: ${{ needs.workflow-scripts.result || 'skipped' }}
          JOB_GO: ${{ needs.go-ci.result || 'skipped' }}
          JOB_PYTHON: ${{ needs.python-ci.result || 'skipped' }}
          JOB_RUST: ${{ needs.rust-ci.result || 'skipped' }}
          JOB_FRONTEND: ${{ needs.frontend-ci.result || 'skipped' }}
          JOB_DOCKER: skipped
          JOB_DOCS: skipped
          CI_GO_FILES: ${{ needs.detect-changes.outputs.go-files }}
          CI_PYTHON_FILES: ${{ needs.detect-changes.outputs.python-files }}
          CI_RUST_FILES: ${{ needs.detect-changes.outputs.rust-files }}
          CI_FRONTEND_FILES: ${{ needs.detect-changes.outputs.frontend-files }}
          CI_DOCKER_FILES: ${{ needs.detect-changes.outputs.docker-files }}
          CI_DOCS_FILES: ${{ needs.detect-changes.outputs.docs-files }}
          CI_WORKFLOW_FILES: ${{ needs.detect-changes.outputs.workflow-files }}
          CI_WORKFLOW_YAML_FILES: ${{ needs.detect-changes.outputs.workflows-files }}
          CI_WORKFLOW_SCRIPT_FILES: ${{ needs.detect-changes.outputs.workflows-scripts }}
          CI_LINT_FILES: ${{ needs.detect-changes.outputs.lint-files }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" generate-ci-summary

      - name: Check overall status
        env:
          JOB_WORKFLOW_LINT: ${{ needs.workflow-lint.result || 'skipped' }}
          JOB_WORKFLOW_SCRIPTS: ${{ needs.workflow-scripts.result || 'skipped' }}
          JOB_GO: ${{ needs.go-ci.result || 'skipped' }}
          JOB_PYTHON: ${{ needs.python-ci.result || 'skipped' }}
          JOB_RUST: ${{ needs.rust-ci.result || 'skipped' }}
          JOB_FRONTEND: ${{ needs.frontend-ci.result || 'skipped' }}
          JOB_DOCKER: skipped
          JOB_DOCS: skipped
        run: python3 "$GHCOMMON_SCRIPTS_DIR/ci_workflow.py" check-ci-status
