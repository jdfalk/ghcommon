# file: .github/workflows/reusable-super-linter.yml
# version: 1.0.0
# guid: b2c3d4e5-f6a7-89bc-def0-123456789bcd

name: Reusable - Super Linter

on:
  workflow_call:
    inputs:
      validate-all-codebase:
        description: "Validate entire codebase instead of just changed files"
        required: false
        default: false
        type: boolean
      default-branch:
        description: "The default branch of the repository"
        required: false
        default: "main"
        type: string
      config-file:
        description: "Path to Super Linter configuration file"
        required: false
        default: ".github/super-linter.env"
        type: string
      filter-regex-exclude:
        description: "Regex to exclude files from linting"
        required: false
        default: ".*\\.git/.*|.*\\.github/copilot/.*|.*\\.vscode/.*|.*node_modules/.*|.*\\.cache/.*"
        type: string
      run-python:
        description: "Enable Python linting"
        required: false
        default: true
        type: boolean
      run-shell:
        description: "Enable shell script linting"
        required: false
        default: true
        type: boolean
      run-markdown:
        description: "Enable Markdown linting"
        required: false
        default: true
        type: boolean
      run-yaml:
        description: "Enable YAML linting"
        required: false
        default: true
        type: boolean
      run-json:
        description: "Enable JSON linting"
        required: false
        default: true
        type: boolean
      run-javascript:
        description: "Enable JavaScript/TypeScript linting"
        required: false
        default: true
        type: boolean
      run-go:
        description: "Enable Go linting"
        required: false
        default: true
        type: boolean
      run-css:
        description: "Enable CSS linting"
        required: false
        default: true
        type: boolean
      run-html:
        description: "Enable HTML linting"
        required: false
        default: true
        type: boolean
      run-protobuf:
        description: "Enable Protobuf linting"
        required: false
        default: true
        type: boolean
      run-github-actions:
        description: "Enable GitHub Actions linting"
        required: false
        default: true
        type: boolean
      run-security:
        description: "Enable security scanning (secrets, Dockerfile)"
        required: false
        default: true
        type: boolean
      enable-auto-fix:
        description: "Enable auto-fixing for supported linters and formatters"
        required: false
        default: true
        type: boolean
      auto-commit-fixes:
        description: "Automatically commit and push fixes when running on main branch or PRs"
        required: false
        default: true
        type: boolean
      commit-message:
        description: "Commit message for auto-fixes"
        required: false
        default: "style: auto-fix linting issues [skip ci]"
        type: string

permissions:
  contents: write # Required for auto-committing fixes
  statuses: write # Required for status updates
  checks: write # Required for check runs
  pull-requests: write # Required for PR comments and updates
  packages: read # Required for package access
  security-events: write # Required for security scanning

jobs:
  super-linter:
    name: Super Linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Full git history is needed to get list of changed files
          fetch-depth: 0
          token: ${{ secrets.JF_CI_GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Setup Super Linter environment
        env:
          # Core settings
          DEFAULT_BRANCH: ${{ inputs.default-branch }}
          VALIDATE_ALL_CODEBASE: ${{ inputs.validate-all-codebase }}
          FILTER_REGEX_EXCLUDE: ${{ inputs.filter-regex-exclude }}

          # Language-specific settings - only enable what we want
          VALIDATE_PYTHON_BLACK: ${{ inputs.run-python }}
          VALIDATE_PYTHON_PYLINT: ${{ inputs.run-python }}
          VALIDATE_PYTHON_RUFF: ${{ inputs.run-python }}
          VALIDATE_BASH: ${{ inputs.run-shell }}
          VALIDATE_BASH_EXEC: ${{ inputs.run-shell }}
          VALIDATE_MARKDOWN: ${{ inputs.run-markdown }}
          VALIDATE_JSON: ${{ inputs.run-json }}
          VALIDATE_YAML: ${{ inputs.run-yaml }}
          VALIDATE_GITHUB_ACTIONS: ${{ inputs.run-github-actions }}
          VALIDATE_JAVASCRIPT_ES: ${{ inputs.run-javascript }}
          VALIDATE_TYPESCRIPT_ES: ${{ inputs.run-javascript }}
          VALIDATE_CSS: ${{ inputs.run-css }}
          VALIDATE_HTML: ${{ inputs.run-html }}
          VALIDATE_GO: ${{ inputs.run-go }}
          VALIDATE_PROTOBUF: ${{ inputs.run-protobuf }}
          VALIDATE_GIT_COMMITLINT: true
          VALIDATE_SECRETS: ${{ inputs.run-security }}
          VALIDATE_DOCKERFILE_HADOLINT: ${{ inputs.run-security }}

          # Disable everything else to avoid conflicts
          VALIDATE_PYTHON_PYINK: false
          VALIDATE_PYTHON_FLAKE8: false
          VALIDATE_PYTHON_ISORT: false
          VALIDATE_PYTHON_MYPY: false
          VALIDATE_SHELL_SHFMT: false
          VALIDATE_CHECKOV: false
          VALIDATE_ENV: false
          VALIDATE_JSCPD: false
          VALIDATE_NATURAL_LANGUAGE: false
          VALIDATE_RUST_2015: false
          VALIDATE_RUST_2018: false
          VALIDATE_RUST_2021: false
          VALIDATE_CLANG_FORMAT: false
          VALIDATE_CPPCHECK: false
          VALIDATE_CPPLINT: false

          # Auto-fix settings (enable fix mode for supported linters)
          FIX_PYTHON_BLACK: ${{ inputs.enable-auto-fix && inputs.run-python }}
          FIX_PYTHON_RUFF: ${{ inputs.enable-auto-fix && inputs.run-python }}
          FIX_JAVASCRIPT_ES: ${{ inputs.enable-auto-fix && inputs.run-javascript }}
          FIX_TYPESCRIPT_ES: ${{ inputs.enable-auto-fix && inputs.run-javascript }}
          FIX_CSS: ${{ inputs.enable-auto-fix && inputs.run-css }}
          FIX_JSON: ${{ inputs.enable-auto-fix && inputs.run-json }}
          FIX_MARKDOWN: ${{ inputs.enable-auto-fix && inputs.run-markdown }}
          FIX_YAML: ${{ inputs.enable-auto-fix && inputs.run-yaml }}
          FIX_GO: ${{ inputs.enable-auto-fix && inputs.run-go }}
          FIX_SHELL_SHFMT: ${{ inputs.enable-auto-fix && inputs.run-shell }}

          # Output and logging settings
          CREATE_LOG_FILE: true
          LOG_FILE: super-linter.log
          SAVE_SUPER_LINTER_OUTPUT: true
          SUPER_LINTER_OUTPUT_DIRECTORY_NAME: super-linter-output

          # Configuration file paths
          PYTHON_BLACK_CONFIG_FILE: .github/linters/.python-black
          PYTHON_PYLINT_CONFIG_FILE: .github/linters/.pylintrc
          PYTHON_RUFF_CONFIG_FILE: .github/linters/ruff.toml
          MARKDOWN_CONFIG_FILE: .github/linters/.markdownlint.json
          YAML_CONFIG_FILE: .github/linters/.yaml-lint.yml
          JAVASCRIPT_ES_CONFIG_FILE: .github/linters/.eslintrc.json
          TYPESCRIPT_ES_CONFIG_FILE: .github/linters/.eslintrc.json

          # Performance and behavior settings
          MULTI_STATUS: true
          PARALLEL: true
        run: |
          # Environment variables are now set securely above
          echo "Super Linter environment configured"

      - name: Load custom configuration
        if: inputs.config-file != '.github/super-linter.env'
        env:
          CONFIG_FILE_PATH: ${{ inputs.config-file }}
        run: |
          if [ -f "${CONFIG_FILE_PATH}" ]; then
            echo "Loading custom configuration from ${CONFIG_FILE_PATH}"
            set -a
            source "${CONFIG_FILE_PATH}"
            set +a
          else
            echo "Warning: Custom config file ${CONFIG_FILE_PATH} not found, using defaults"
          fi

      - name: Run Super Linter
        uses: super-linter/super-linter@v7
        env:
          # Core settings
          DEFAULT_BRANCH: ${{ inputs.default-branch }}
          VALIDATE_ALL_CODEBASE: ${{ inputs.validate-all-codebase }}
          FILTER_REGEX_EXCLUDE: ${{ inputs.filter-regex-exclude }}

          # Language-specific settings - only enable what we want
          VALIDATE_PYTHON_BLACK: ${{ inputs.run-python }}
          VALIDATE_PYTHON_PYLINT: ${{ inputs.run-python }}
          VALIDATE_PYTHON_RUFF: ${{ inputs.run-python }}
          VALIDATE_BASH: ${{ inputs.run-shell }}
          VALIDATE_BASH_EXEC: ${{ inputs.run-shell }}
          VALIDATE_MARKDOWN: ${{ inputs.run-markdown }}
          VALIDATE_JSON: ${{ inputs.run-json }}
          VALIDATE_YAML: ${{ inputs.run-yaml }}
          VALIDATE_GITHUB_ACTIONS: ${{ inputs.run-github-actions }}
          VALIDATE_JAVASCRIPT_ES: ${{ inputs.run-javascript }}
          VALIDATE_TYPESCRIPT_ES: ${{ inputs.run-javascript }}
          VALIDATE_CSS: ${{ inputs.run-css }}
          VALIDATE_HTML: ${{ inputs.run-html }}
          VALIDATE_GO: ${{ inputs.run-go }}
          VALIDATE_PROTOBUF: ${{ inputs.run-protobuf }}
          VALIDATE_GIT_COMMITLINT: true
          VALIDATE_SECRETS: ${{ inputs.run-security }}
          VALIDATE_DOCKERFILE_HADOLINT: ${{ inputs.run-security }}

          # Disable everything else to avoid conflicts
          VALIDATE_PYTHON_PYINK: false
          VALIDATE_PYTHON_FLAKE8: false
          VALIDATE_PYTHON_ISORT: false
          VALIDATE_PYTHON_MYPY: false
          VALIDATE_SHELL_SHFMT: false
          VALIDATE_CHECKOV: false
          VALIDATE_ENV: false
          VALIDATE_JSCPD: false
          VALIDATE_NATURAL_LANGUAGE: false
          VALIDATE_RUST_2015: false
          VALIDATE_RUST_2018: false
          VALIDATE_RUST_2021: false
          VALIDATE_CLANG_FORMAT: false
          VALIDATE_CPPCHECK: false
          VALIDATE_CPPLINT: false

          # Auto-fix settings (enable fix mode for supported linters)
          FIX_PYTHON_BLACK: ${{ inputs.enable-auto-fix && inputs.run-python }}
          FIX_PYTHON_RUFF: ${{ inputs.enable-auto-fix && inputs.run-python }}
          FIX_JAVASCRIPT_ES: ${{ inputs.enable-auto-fix && inputs.run-javascript }}
          FIX_TYPESCRIPT_ES: ${{ inputs.enable-auto-fix && inputs.run-javascript }}
          FIX_CSS: ${{ inputs.enable-auto-fix && inputs.run-css }}
          FIX_JSON: ${{ inputs.enable-auto-fix && inputs.run-json }}
          FIX_MARKDOWN: ${{ inputs.enable-auto-fix && inputs.run-markdown }}
          FIX_YAML: ${{ inputs.enable-auto-fix && inputs.run-yaml }}
          FIX_GO: ${{ inputs.enable-auto-fix && inputs.run-go }}
          FIX_SHELL_SHFMT: ${{ inputs.enable-auto-fix && inputs.run-shell }}

          # Output and logging settings
          CREATE_LOG_FILE: true
          LOG_FILE: super-linter.log
          SAVE_SUPER_LINTER_OUTPUT: true
          SUPER_LINTER_OUTPUT_DIRECTORY_NAME: super-linter-output

          # Configuration file paths
          PYTHON_BLACK_CONFIG_FILE: .github/linters/.python-black
          PYTHON_PYLINT_CONFIG_FILE: .github/linters/.pylintrc
          PYTHON_RUFF_CONFIG_FILE: .github/linters/ruff.toml
          MARKDOWN_CONFIG_FILE: .github/linters/.markdownlint.json
          YAML_CONFIG_FILE: .github/linters/.yaml-lint.yml
          JAVASCRIPT_ES_CONFIG_FILE: .github/linters/.eslintrc.json
          TYPESCRIPT_ES_CONFIG_FILE: .github/linters/.eslintrc.json

          # Performance and behavior settings
          MULTI_STATUS: true
          PARALLEL: true

          GITHUB_TOKEN: ${{ secrets.JF_CI_GH_PAT || secrets.GITHUB_TOKEN }}

      - name: Check for auto-fixes
        if: inputs.enable-auto-fix == true
        id: check-fixes
        run: |
          # Check if there are any changes made by Super Linter auto-fix
          if git diff --quiet; then
            echo "has_fixes=false" >> $GITHUB_OUTPUT
            echo "No auto-fixes applied"
          else
            echo "has_fixes=true" >> $GITHUB_OUTPUT
            echo "Auto-fixes applied, changes detected:"
            git diff --name-only
          fi

      - name: Commit and push auto-fixes
        if: steps.check-fixes.outputs.has_fixes == 'true' && inputs.auto-commit-fixes == true
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Super Linter Auto-fix"

          # Add all changes
          git add .

          # Commit changes
          git commit -m "${{ inputs.commit-message }}"

          # Push changes
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, push to the PR branch
            git push origin HEAD:${{ github.head_ref }}
            echo "✅ Auto-fixes committed and pushed to PR branch: ${{ github.head_ref }}"
          else
            # For push events, push to the current branch
            git push origin HEAD
            echo "✅ Auto-fixes committed and pushed to branch: ${{ github.ref_name }}"
          fi

      - name: Prepare Super Linter outputs
        if: always()
        run: |
          echo "Checking for Super Linter output files..."

          # Create a report directory
          mkdir -p super-linter-reports

          # Look for log files in different possible locations
          if [ -f "super-linter.log" ]; then
            cp super-linter.log super-linter-reports/
            echo "Found super-linter.log"
          fi

          if [ -f "/tmp/super-linter.log" ]; then
            cp /tmp/super-linter.log super-linter-reports/
            echo "Found /tmp/super-linter.log"
          fi

          # Look for output directory
          if [ -d "super-linter-output" ]; then
            cp -r super-linter-output/* super-linter-reports/ 2>/dev/null || true
            echo "Found super-linter-output directory"
          fi

          # Create a summary report from any available logs
          if [ -f "super-linter-reports/super-linter.log" ]; then
            echo "Creating summary report from log..."
            tail -n 100 super-linter-reports/super-linter.log > super-linter-reports/super-linter.report
          else
            echo "No log file found, creating basic report..."
            echo "Super Linter completed - no detailed log available" > super-linter-reports/super-linter.report
          fi

          # List what we found
          echo "Files in super-linter-reports:"
          ls -la super-linter-reports/ || echo "No files found"

      - name: Upload Super Linter results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: super-linter-results
          path: |
            super-linter-reports/
            super-linter.log
            super-linter-output/
          retention-days: 7
          if-no-files-found: warn

      - name: Comment PR with linting results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          HAS_AUTO_FIXES: ${{ steps.check-fixes.outputs.has_fixes }}
          AUTO_FIX_ENABLED: ${{ inputs.enable-auto-fix }}
          AUTO_COMMIT_ENABLED: ${{ inputs.auto-commit-fixes }}
        with:
          github-token: ${{ secrets.JF_CI_GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/super-linter-pr-comment.js');
            return await script({ github, context, core });
