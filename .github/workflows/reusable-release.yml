# file: .github/workflows/reusable-release.yml
# version: 2.9.0
# guid: 7b8c9d0e-1f2a-3b4c-5d6e-7f8a9b0c1d2e

name: Reusable Release Coordinator

on:
  workflow_call:
    inputs:
      release-type:
        description: 'Release type (auto, major, minor, patch)'
        required: false
        type: string
        default: 'auto'
      build-target:
        description: 'Build target (all, go, python, rust, frontend, docker, protobuf)'
        required: false
        type: string
        default: 'all'
      prerelease:
        description: 'Create as prerelease'
        required: false
        type: boolean
        default: false
      draft:
        description: 'Create as draft'
        required: false
        type: boolean
        default: false
      skip-language-detection:
        description: 'Skip automatic language detection'
        required: false
        type: boolean
        default: false
      go-enabled:
        description: 'Force enable Go builds'
        required: false
        type: boolean
        default: false
      python-enabled:
        description: 'Force enable Python builds'
        required: false
        type: boolean
        default: false
      rust-enabled:
        description: 'Force enable Rust builds'
        required: false
        type: boolean
        default: false
      frontend-enabled:
        description: 'Force enable Frontend builds'
        required: false
        type: boolean
        default: false
      docker-enabled:
        description: 'Force enable Docker builds'
        required: false
        type: boolean
        default: false
      protobuf-enabled:
        description: 'Force enable Protobuf builds'
        required: false
        type: boolean
        default: false
      system-packages:
        description: 'Space-separated list of apt packages to install before build (e.g. libtag1-dev)'
        required: false
        type: string
        default: ''
      pre-build-script:
        description: 'Shell script to run before goreleaser (e.g. build frontend assets)'
        required: false
        type: string
        default: ''
    outputs:
      release-created:
        description: 'Whether a release was created'
        value: ${{ jobs.build-status.outputs.release-created }}
      release-tag:
        description: 'The created release tag'
        value: ${{ jobs.detect-languages.outputs.release-tag }}
      primary-language:
        description: 'The detected primary language'
        value: ${{ jobs.detect-languages.outputs.primary-language }}
      release-strategy:
        description: 'The release strategy used (stable, prerelease, draft)'
        value: ${{ jobs.detect-languages.outputs.release-branch-strategy }}

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

concurrency:
  group: release-${{ github.repository }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Load unified configuration
  load-config:
    name: Load Repository Configuration
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.load-config.outputs.config }}
      has-config: ${{ steps.load-config.outputs.has-config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Load repository configuration
        id: load-config
        uses: jdfalk/load-config-action@f53a2a9d7bc80d26be0f3339188fe84f2feabb38 # v1.1.3
        with:
          config-file: .github/repository-config.yml
          fail-on-missing: false

  # Detect what languages/technologies are present
  detect-languages:
    name: Detect Project Languages
    runs-on: ubuntu-latest
    needs: [load-config]
    outputs:
      has-go: ${{ steps.detect.outputs.has-go }}
      has-python: ${{ steps.detect.outputs.has-python }}
      has-frontend: ${{ steps.detect.outputs.has-frontend }}
      has-docker: ${{ steps.detect.outputs.has-docker }}
      has-rust: ${{ steps.detect.outputs.has-rust }}
      protobuf-needed: ${{ steps.detect.outputs.protobuf-needed }}
      primary-language: ${{ steps.detect.outputs.primary-language }}
      go-matrix: ${{ steps.detect.outputs.go-matrix }}
      python-matrix: ${{ steps.detect.outputs.python-matrix }}
      frontend-matrix: ${{ steps.detect.outputs.frontend-matrix }}
      docker-matrix: ${{ steps.detect.outputs.docker-matrix }}
      rust-matrix: ${{ steps.detect.outputs.rust-matrix }}
      registry: ${{ steps.env-setup.outputs.registry }}
      image-name: ${{ steps.env-setup.outputs.image-name }}
      release-tag: ${{ steps.version.outputs.tag }}
      release-branch-strategy: ${{ steps.release-strategy.outputs.strategy }}
      auto-prerelease: ${{ steps.release-strategy.outputs.auto-prerelease }}
      auto-draft: ${{ steps.release-strategy.outputs.auto-draft }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup environment variables
        id: env-setup
        run: |
          echo "registry=${REGISTRY}" >> "$GITHUB_OUTPUT"
          echo "image-name=${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
      - name: Detect project languages and generate matrices
        id: detect
        uses: jdfalk/detect-languages-action@d2f4d111e09c0e969423a79600e95ab960c95ebe # v1.1.3
        with:
          skip-detection: ${{ inputs.skip-language-detection }}
          build-target: ${{ inputs.build-target || 'all' }}
          go-enabled: ${{ inputs.go-enabled && 'true' || 'auto' }}
          python-enabled: ${{ inputs.python-enabled && 'true' || 'auto' }}
          rust-enabled: ${{ inputs.rust-enabled && 'true' || 'auto' }}
          frontend-enabled: ${{ inputs.frontend-enabled && 'true' || 'auto' }}
          docker-enabled: ${{ inputs.docker-enabled && 'true' || 'auto' }}
          protobuf-enabled: ${{ inputs.protobuf-enabled && 'true' || 'auto' }}

      - name: Determine release strategy based on branch
        id: release-strategy
        uses: jdfalk/release-strategy-action@32bb24ac9d8dc50917d9f64e9035da85bd4a6a98 # v1.1.3
        with:
          branch-name: ${{ github.ref_name }}
          force-prerelease: ${{ inputs.prerelease }}
          force-draft: ${{ inputs.draft }}

      - name: Generate semantic release version
        id: version
        uses: jdfalk/generate-version-action@b20e8fcdd2270aed9512aa3be5b6cb8610c42d97 # v1.1.3
        with:
          release-type: ${{ inputs.release-type || 'auto' }}
          branch-name: ${{ github.ref_name }}

  # Protocol Buffer Generation (if needed)
  build-protobuf:
    name: Generate Protocol Buffers
    needs: [detect-languages]
    if: ${{ needs.detect-languages.outputs.protobuf-needed == 'true' }}
    uses: jdfalk/ghcommon/.github/workflows/release-protobuf.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    secrets: inherit

  # Go Build
  build-go:
    name: Build Go Components
    needs: [detect-languages, build-protobuf]
    if: |
      always() &&
      needs.detect-languages.outputs.has-go == 'true' &&
      (inputs.build-target == 'all' || inputs.build-target == 'go')
    uses: jdfalk/ghcommon/.github/workflows/release-go.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    with:
      go-matrix: ${{ needs.detect-languages.outputs.go-matrix }}
      protobuf-artifacts: ${{ needs.detect-languages.outputs.protobuf-needed }}
      release-version: ${{ needs.detect-languages.outputs.release-tag }}
      system-packages: ${{ inputs.system-packages }}
      pre-build-script: ${{ inputs.pre-build-script }}
    secrets: inherit

  # Python Build
  build-python:
    name: Build Python Components
    needs: [detect-languages, build-protobuf]
    if: |
      always() &&
      needs.detect-languages.outputs.has-python == 'true' &&
      (inputs.build-target == 'all' || inputs.build-target == 'python')
    uses: jdfalk/ghcommon/.github/workflows/release-python.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    with:
      python-matrix: ${{ needs.detect-languages.outputs.python-matrix }}
      protobuf-artifacts: ${{ needs.detect-languages.outputs.protobuf-needed }}
    secrets: inherit

  # Rust Build
  build-rust:
    name: Build Rust Components
    needs: [detect-languages, build-protobuf]
    if: |
      always() &&
      needs.detect-languages.outputs.has-rust == 'true' &&
      (inputs.build-target == 'all' || inputs.build-target == 'rust')
    uses: jdfalk/ghcommon/.github/workflows/release-rust.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    with:
      protobuf-artifacts: ${{ needs.detect-languages.outputs.protobuf-needed }}
      release-version: ${{ needs.detect-languages.outputs.release-tag }}
    secrets: inherit

  # Frontend Build
  build-frontend:
    name: Build Frontend Components
    needs: [detect-languages]
    if: |
      always() &&
      needs.detect-languages.outputs.has-frontend == 'true' &&
      (inputs.build-target == 'all' || inputs.build-target == 'frontend')
    uses: jdfalk/ghcommon/.github/workflows/release-frontend.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    with:
      frontend-matrix: ${{ needs.detect-languages.outputs.frontend-matrix }}
    secrets: inherit

  # Docker Build
  build-docker:
    name: Build Docker Images
    needs: [detect-languages, build-go, build-python, build-rust]
    if: |
      always() &&
      needs.detect-languages.outputs.has-docker == 'true' &&
      (inputs.build-target == 'all' || inputs.build-target == 'docker')
    uses: jdfalk/ghcommon/.github/workflows/release-docker.yml@07c1dbb1c2e2c8ed1b3e1637fd27cba1197f6769 # main
    with:
      docker-matrix: ${{ needs.detect-languages.outputs.docker-matrix }}
      registry: ${{ needs.detect-languages.outputs.registry }}
      image-name: ${{ needs.detect-languages.outputs.image-name }}
    secrets: inherit

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs:
      [
        detect-languages,
        build-go,
        build-python,
        build-rust,
        build-frontend,
        build-docker,
      ]
    if: |
      always() &&
      !failure() &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    outputs:
      version: ${{ steps.version.outputs.version }}
      release-id: ${{ steps.release.outputs.id }}
      release-created: ${{ steps.check-release.outputs.created }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Get version
        id: version
        env:
          DETECTED_RELEASE_TAG: ${{ needs.detect-languages.outputs.release-tag }}
        run: |
          VERSION="$DETECTED_RELEASE_TAG"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          PRIMARY_LANGUAGE: ${{ needs.detect-languages.outputs.primary-language }}
          RELEASE_STRATEGY: ${{ needs.detect-languages.outputs.release-branch-strategy }}
          AUTO_PRERELEASE: ${{ needs.detect-languages.outputs.auto-prerelease }}
          AUTO_DRAFT: ${{ needs.detect-languages.outputs.auto-draft }}
        run: |
          python3 "$GHCOMMON_SCRIPTS_DIR/release_workflow.py" "generate-changelog"

      - name: Download all build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ./artifacts
      - name: Package and organize release artifacts
        id: package-artifacts
        uses: jdfalk/package-assets-action@44d1b757a14839d9eab209434b80d0437c53e686 # v1.1.3
        with:
          artifacts-dir: ./artifacts

      - name: Create GitHub Release
        id: release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        if: github.event_name != 'pull_request'
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.changelog_content }}

            ## ðŸ“¦ Release Assets

            This release includes organized packages for easy consumption:

            ### Binaries
            Pre-built binaries for multiple platforms with SHA256 checksums:
            - **Windows**: `*-windows-amd64.exe`, `*-windows-arm64.exe`
            - **Linux**: `*-linux-amd64`, `*-linux-arm64`
            - **macOS**: `*-darwin-amd64`, `*-darwin-arm64`

            Each binary includes a `.sha256` checksum file for verification.

            ### SDKs
            - **Go SDK**: `*-go-sdk.tar.gz` / `*-go-sdk.zip`
            - **Python SDK**: `*-python-sdk.tar.gz` / `*-python-sdk.zip`

            ### Documentation
            - **API Documentation**: `*-docs.tar.gz` / `*-docs.zip`

            See `MANIFEST.md` in the release assets for a complete list of all files and their sizes.

            ---
            *Generated automatically from commit ${{ github.sha }}*
          draft: ${{ needs.detect-languages.outputs.auto-draft }}
          prerelease: ${{ needs.detect-languages.outputs.auto-prerelease }}
          files: |
            ./artifacts/**/*
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check release created
        id: check-release
        env:
          RELEASE_OUTCOME: ${{ steps.release.outcome }}
        run: |
          created=false
          if [ "${RELEASE_OUTCOME:-failure}" = "success" ]; then
            created=true
          fi
          {
            echo "created=${created}"
            echo "release-created=${created}"
          } >> "$GITHUB_OUTPUT"

  publish-github-packages:
    name: Publish GitHub Packages
    runs-on: ubuntu-latest
    needs: [load-config, detect-languages, create-release]
    if: |
      always() &&
      needs.create-release.outputs.release-created == 'true'
    env:
      REPOSITORY_CONFIG: ${{ needs.load-config.outputs.config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine ghcommon workflow ref
        id: ghcommon-ref
        run: |
          ref="${GITHUB_WORKFLOW_REF##*@}"
          if [[ -z "$ref" || "$ref" == "$GITHUB_WORKFLOW_REF" ]]; then
            ref="refs/heads/main"
          fi
          echo "ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          path: ghcommon-workflow-scripts
          sparse-checkout: |
            .github/workflows/scripts
          sparse-checkout-cone-mode: false

      - name: Configure workflow script path
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$PWD/ghcommon-workflow-scripts/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Download release artifacts for publishing
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: packages
          merge-multiple: true
          # if-no-files-found: ignore

      - name: Ensure packages directory exists
        run: mkdir -p packages

      - name: Publish artifacts to GitHub Packages
        env:
          PRIMARY_LANGUAGE: ${{ needs.detect-languages.outputs.primary-language || 'unknown' }}
          RELEASE_TAG: ${{ needs.detect-languages.outputs.release-tag }}
          RELEASE_STRATEGY: ${{ needs.detect-languages.outputs.release-branch-strategy }}
          BRANCH_NAME: ${{ github.ref_name }}
          GHCOMMON_SCRIPTS_DIR: ${{ env.GHCOMMON_SCRIPTS_DIR }}
        run: |
          set -euo pipefail
          SCRIPT_PATH="${GHCOMMON_SCRIPTS_DIR}/publish_to_github_packages.py"

          ARGS=(
            "python3"
            "$SCRIPT_PATH"
            "--language" "${PRIMARY_LANGUAGE:-unknown}"
            "--tag" "${RELEASE_TAG:-}"
            "--branch" "${BRANCH_NAME:-}"
            "--artifacts-dir" "packages"
            "--require-github"
          )

          if [ "${RELEASE_STRATEGY:-}" = "stable" ]; then
            ARGS+=("--is-stable")
          fi

          "${ARGS[@]}"

  # Update floating version tags
  update-floating-tags:
    name: Update Floating Tags
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-languages, create-release]
    if: |
      needs.create-release.outputs.release-created == 'true' &&
      needs.detect-languages.outputs.release-branch-strategy == 'stable' &&
      !inputs.prerelease &&
      !inputs.draft
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Parse version and update floating tags
        env:
          VERSION_TAG: ${{ needs.detect-languages.outputs.release-tag }}
        run: |
          set -euo pipefail

          echo "ðŸ“Œ Updating floating tags for $VERSION_TAG"

          # Parse version (e.g., v1.2.3)
          if [[ ! $VERSION_TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "::warning::Version tag $VERSION_TAG is not in semver format, skipping floating tag update"
            exit 0
          fi

          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update major version tag (v1) with retry logic
          MAJOR_TAG="v${MAJOR}"
          echo "ðŸ·ï¸  Updating $MAJOR_TAG to point to $VERSION_TAG"
          git tag -fa "$MAJOR_TAG" "$VERSION_TAG" -m "chore(release): update $MAJOR_TAG to $VERSION_TAG"

          # Retry logic for push
          retry_count=0
          max_retries=3
          until git push origin "$MAJOR_TAG" --force || [ $retry_count -eq $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "âš ï¸  Retry $retry_count/$max_retries for $MAJOR_TAG after 5 seconds..."
            sleep 5
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ Failed to push $MAJOR_TAG after $max_retries attempts"
            exit 1
          fi
          echo "âœ… Updated $MAJOR_TAG"

          # Update minor version tag (v1.2) with retry logic
          MINOR_TAG="v${MAJOR}.${MINOR}"
          echo "ðŸ·ï¸  Updating $MINOR_TAG to point to $VERSION_TAG"
          git tag -fa "$MINOR_TAG" "$VERSION_TAG" -m "chore(release): update $MINOR_TAG to $VERSION_TAG"

          # Retry logic for push
          retry_count=0
          until git push origin "$MINOR_TAG" --force || [ $retry_count -eq $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "âš ï¸  Retry $retry_count/$max_retries for $MINOR_TAG after 5 seconds..."
            sleep 5
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ Failed to push $MINOR_TAG after $max_retries attempts"
            exit 1
          fi
          echo "âœ… Updated $MINOR_TAG"

          echo "ðŸŽ‰ Floating tags updated successfully"

  # Final status check
  build-status:
    name: Release Status Summary
    runs-on: ubuntu-latest
    needs:
      [
        detect-languages,
        build-go,
        build-python,
        build-rust,
        build-frontend,
        build-docker,
        create-release,
        publish-github-packages,
        update-floating-tags,
      ]
    if: always()
    outputs:
      release-created: ${{ needs.create-release.outputs.release-created || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Detect ghcommon ref
        id: ghcommon-ref
        run: |
          if [ -f .github/ghcommon-ref.txt ]; then
            echo "ref=$(cat .github/ghcommon-ref.txt)" >> "$GITHUB_OUTPUT"
          else
            echo "ref=main" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout ghcommon workflow scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          repository: jdfalk/ghcommon
          ref: ${{ steps.ghcommon-ref.outputs.ref }}
          sparse-checkout: |
            .github/workflows/scripts
          path: .ghcommon

      - name: Set up GHCOMMON_SCRIPTS_DIR
        run: |
          echo "GHCOMMON_SCRIPTS_DIR=$GITHUB_WORKSPACE/.ghcommon/.github/workflows/scripts" >> "$GITHUB_ENV"

      - name: Generate release summary
        env:
          SUMMARY_PRIMARY_LANGUAGE: ${{ needs.detect-languages.outputs.primary-language }}
          SUMMARY_BUILD_TARGET: ${{ inputs.build-target }}
          SUMMARY_RELEASE_TAG: ${{ needs.detect-languages.outputs.release-tag }}
          SUMMARY_RELEASE_STRATEGY: ${{ needs.detect-languages.outputs.release-branch-strategy }}
          SUMMARY_BRANCH: ${{ github.ref_name }}
          SUMMARY_GO_RESULT: ${{ needs.build-go.result || 'skipped' }}
          SUMMARY_PYTHON_RESULT: ${{ needs.build-python.result || 'skipped' }}
          SUMMARY_RUST_RESULT: ${{ needs.build-rust.result || 'skipped' }}
          SUMMARY_FRONTEND_RESULT: ${{ needs.build-frontend.result || 'skipped' }}
          SUMMARY_DOCKER_RESULT: ${{ needs.build-docker.result || 'skipped' }}
          SUMMARY_RELEASE_RESULT: ${{ needs.create-release.result || 'skipped' }}
          SUMMARY_PUBLISH_RESULT: ${{ needs.publish-github-packages.result || 'skipped' }}
          SUMMARY_RELEASE_CREATED: ${{ needs.create-release.outputs.release-created || 'false' }}
          SUMMARY_AUTO_PRERELEASE: ${{ needs.detect-languages.outputs.auto-prerelease || 'false' }}
          SUMMARY_AUTO_DRAFT: ${{ needs.detect-languages.outputs.auto-draft || 'false' }}
        run: python3 "$GHCOMMON_SCRIPTS_DIR/generate_release_summary.py"
