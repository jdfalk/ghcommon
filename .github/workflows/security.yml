# file: .github/workflows/security.yml
# version: 3.2.0
# guid: s3c4r5t6-y7a8-b9c0-d1e2-f3a4b5c6d7e8

name: Security

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM UTC
  workflow_dispatch:
    inputs:
      skip-codeql:
        description: 'Skip CodeQL analysis'
        required: false
        type: boolean
        default: false
      skip-dependency-review:
        description: 'Skip dependency review'
        required: false
        type: boolean
        default: false
      skip-security-audit:
        description: 'Skip security audit'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect available languages
  detect-languages:
    name: Detect Languages
    runs-on: ubuntu-latest
    outputs:
      languages: ${{ steps.detect.outputs.languages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Detect available languages
        id: detect
        run: python3 .github/workflows/scripts/detect_languages.py

  # CodeQL Analysis
  codeql-analysis:
    name: CodeQL Analysis
    needs: detect-languages
    if: ${{ !inputs.skip-codeql && fromJSON(needs.detect-languages.outputs.languages)[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJSON(needs.detect-languages.outputs.languages) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Set up language environment
        run: |
          case "${{ matrix.language }}" in
            go)
              if [ -f go.mod ]; then
                go mod download
              fi
              ;;
            javascript)
              if [ -f package.json ]; then
                npm ci || npm install
              fi
              ;;
            python)
              if [ -f requirements.txt ]; then
                pip install -r requirements.txt
              fi
              ;;
          esac

      - name: Autobuild
        uses: github/codeql-action/autobuild@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        with:
          category: '/language:${{ matrix.language }}'

  # Dependency Review
  dependency-review:
    name: Dependency Review
    needs: detect-languages
    if: ${{ !inputs.skip-dependency-review && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          config-file: './.github/dependency-review-config.yml'
          fail-on-severity: moderate

  # Security Audit
  security-audit:
    name: Security Audit
    needs: detect-languages
    if: ${{ !inputs.skip-security-audit }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Go security audit
        if: hashFiles('go.mod') != ''
        run: |
          go install github.com/securecodewarrior/go-audit@latest
          go list -json -deps ./... | go-audit

      - name: Python security audit
        if: hashFiles('requirements*.txt', 'pyproject.toml') != ''
        run: |
          pip install safety bandit
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt
          fi
          if find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | head -1 | grep -q .; then
            bandit -r . -x ./venv,./venv3,./.venv -f json -o bandit-report.json || true
            if [ -f bandit-report.json ]; then
              echo "Bandit security scan completed. Report:"
              cat bandit-report.json
            fi
          fi

      - name: Node.js security audit
        if: hashFiles('package*.json') != ''
        run: |
          if [ -f package.json ]; then
            npm audit --audit-level=moderate || true
          fi

      - name: Rust security audit
        if: hashFiles('Cargo.toml') != ''
        run: |
          cargo install cargo-audit
          cargo audit

  # Trivy vulnerability scanning
  trivy-scan:
    name: Trivy Security Scan
    needs: detect-languages
    if: ${{ !inputs.skip-security-audit }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8cce1229c54b2c9bd0d8 # v0.31.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4.32.2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Security summary
  security-summary:
    name: Security Summary
    needs:
      [
        detect-languages,
        codeql-analysis,
        dependency-review,
        security-audit,
        trivy-scan,
      ]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate security summary
        uses: ./.github/actions/security-summary
        with:
          codeql-result: ${{ needs.codeql-analysis.result || 'skipped' }}
          dependency-review-result: ${{ needs.dependency-review.result || 'skipped' }}
          security-audit-result: ${{ needs.security-audit.result || 'skipped' }}
          trivy-result: ${{ needs.trivy-scan.result || 'skipped' }}
