# file: .github/workflows/release-docker.yml
# version: 1.0.1
# guid: d1e2f3a4-b5c6-d7e8-f9a0-b1c2d3e4f5a6
# DO NOT EDIT: This file is managed centrally in ghcommon repository
# To update: Edit the version in jdfalk/ghcommon and it will be synced to all repos

name: Docker Release Plugin

on:
  workflow_call:
    inputs:
      depends_on_language:
        description: "Language this Docker build depends on"
        required: false
        default: ""
        type: string
      use_release_artifacts:
        description: "Use pre-built release artifacts"
        required: false
        default: true
        type: boolean
      platforms:
        description: "Target platforms"
        required: false
        default: "linux/amd64,linux/arm64"
        type: string
      registry:
        description: "Container registry"
        required: false
        default: "ghcr.io"
        type: string
      push:
        description: "Push image to registry"
        required: false
        default: true
        type: boolean
      use_buildah:
        description: "Use buildah instead of docker"
        required: false
        default: false
        type: boolean
    outputs:
      image-digest:
        description: "The built image digest"
        value: ${{ jobs.build-docker.outputs.digest }}
      image-tags:
        description: "The built image tags"
        value: ${{ jobs.build-docker.outputs.tags }}

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

env:
  REGISTRY: ${{ inputs.registry }}
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Detect Docker configuration and dependencies
  detect-config:
    name: Detect Docker Configuration
    runs-on: ubuntu-latest
    outputs:
      has-dockerfile: ${{ steps.check.outputs.has-dockerfile }}
      dockerfile-path: ${{ steps.check.outputs.dockerfile-path }}
      has-compose: ${{ steps.check.outputs.has-compose }}
      should-build: ${{ steps.check.outputs.should-build }}
      build-args: ${{ steps.check.outputs.build-args }}
      depends-on: ${{ steps.check.outputs.depends-on }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Docker files and dependencies
        id: check
        env:
          DEPENDS_ON_LANGUAGE: ${{ inputs.depends_on_language }}
        run: python3 .github/scripts/sync-release-build-artifacts.py