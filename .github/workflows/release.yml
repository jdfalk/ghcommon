# file: .github/workflows/release.yml
# version: 2.0.0
# guid: a1b2c3d4-e5f6-7a8b-9c0d-1e2f3a4b5c6d
#
# ⚠️  CENTRAL SOURCE OF TRUTH: This file is maintained in jdfalk/ghcommon
# To update this workflow:
# 1. Edit the file in jdfalk/ghcommon/.github/workflows/release.yml
# 2. Commit changes to ghcommon
# 3. Copy to other repositories using the sync process
#
# DO NOT edit this file directly in individual repositories!

# file: .github/workflows/release.yml
# version: 1.0.0
# guid: f5a6b7c8-d9e0-f1a2-b3c4-d5e6f7a8b9c0
# DO NOT EDIT: This file is managed centrally in ghcommon repository
# To update: Edit the version in jdfalk/ghcommon and it will be synced to all repos

name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (will override conventional commit detection)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - patch
          - minor
          - major
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean
      draft:
        description: "Create as draft?"
        required: false
        default: false
        type: boolean
      force_language:
        description: "Force specific language (optional)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - rust
          - go
          - python
          - javascript
          - typescript

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write
  security-events: write

jobs:
  detect-language:
    name: Detect Programming Language
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.detect.outputs.language }}
      should-release: ${{ steps.detect.outputs.should-release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect primary language
        id: detect
        env:
          FORCE_LANGUAGE: ${{ github.event.inputs.force_language }}
        run: python3 .github/scripts/sync-release-build-artifacts.py